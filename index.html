<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario · Recordatorios</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<meta name="theme-color" content="#0e1118" />

<style>
  :root{
    --bg:#07090e; --panel:#0e1118; --card:#111522; --glass:rgba(20,23,35,.55);
    --text:#f4f7ff; --muted:#a9b3c5; --border:rgba(255,255,255,.08);
    --accent-a:#30e0a1; --accent-b:#7b7bff; --accent-c:#ff77e1; --ring:rgba(123,123,255,.55);
    --shadow:0 18px 45px rgba(0,0,0,.45); --radius:22px;
    --u-high:#ff6161; --u-med:#ffd157; --u-low:#63f3a7; --u-past:#93a0b5;
    --touch:48px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    --focus-glow: 0 0 0 3px rgba(123, 123, 255, 0.4);
    --card-padding: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:"Sora",system-ui,-apple-system,Segoe UI,Roboto,"Inter",sans-serif;
    background: radial-gradient(1000px 600px at 50% -260px, #151827 20%, var(--bg) 60%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  /* blobs decorativos */
  .bg-blobs::before,.bg-blobs::after{
    content:""; position:fixed; inset:auto; z-index:-1; filter:blur(70px); opacity:.45; pointer-events:none;
    width:380px; height:380px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #1de9b6, transparent 60%);
    animation: float1 16s ease-in-out infinite;
  }
  .bg-blobs::after{
    width:420px; height:420px; right:-120px; bottom:-140px; opacity:.35;
    background: radial-gradient(circle at 70% 40%, #7c8cff, transparent 60%);
    animation: float2 22s ease-in-out infinite;
  }
  @keyframes float1{0%,100%{transform:translate(-80px,-60px)}50%{transform:translate(20px,10px)}}
  @keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(-40px,40px)}}

  .app{min-height:100dvh; padding-bottom:calc(env(safe-area-inset-bottom) + 84px); max-width:520px; margin:0 auto; display:flex; flex-direction:column;}

  /* topbar */
  .topbar{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg, rgba(7,9,14,.95) 0%, rgba(7,9,14,.7) 100%);
    backdrop-filter: blur(14px);
    border-bottom:1px solid var(--border);
    transition: var(--transition);
  }
  .topbar.scrolled { background: rgba(7,9,14,0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .topbar-inner{ display:flex; align-items:center; gap:10px; padding: calc(env(safe-area-inset-top) + 12px) 16px 10px; }
  .round{
    width:var(--touch); height:var(--touch);
    display:grid; place-items:center; border-radius:14px;
    border:1px solid var(--border); background:#0b0f18;
    color:var(--text); cursor:pointer; transition: var(--transition); font-weight: 600;
  }
  .round:hover, .round:focus { transform: translateY(-2px); border-color: rgba(123, 123, 255, 0.4); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .round:active{ transform:scale(.95) }
  .title{ flex:1; text-align:center; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:700; letter-spacing:.3px; }
  .title .month-year{
    font-size:1.2rem;
    background: linear-gradient(90deg,var(--accent-a),var(--accent-b),var(--accent-c));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .chip{
    border:1px solid var(--border); color:var(--muted);
    padding:6px 12px; border-radius:999px; font-size:.82rem;
    background:#0b0f18; cursor:pointer; transition: var(--transition);
  }
  .chip:hover, .chip:focus { background: rgba(123, 123, 255, 0.1); border-color: rgba(123, 123, 255, 0.4); color: #dbe4ff; }
  .streak{
    font-size:.78rem; background: linear-gradient(135deg, #ff9a3d, #ff6b6b);
    -webkit-background-clip: text; background-clip: text; color: transparent;
    font-weight: 600; padding: 4px 8px; border-radius: 12px; background-color: rgba(255, 107, 107, 0.1);
  }

  /* calendario */
  .card{
    margin:16px; padding:var(--card-padding); border-radius:26px;
    background: linear-gradient(var(--card), var(--card)) padding-box,
               linear-gradient(135deg, rgba(48,224,161,.35), rgba(123,123,255,.28), rgba(255,119,225,.28)) border-box;
    border:1px solid transparent; box-shadow: var(--shadow);
    transition: var(--transition);
  }
  .weekdays{
    display:grid; grid-template-columns:repeat(7,1fr);
    padding:10px 10px 12px; gap:6px;
    font-size:.82rem; color:#c6ceea; text-align:center; letter-spacing:.3px; font-weight: 600;
  }
  .weekdays div:nth-child(6), .weekdays div:nth-child(7){ color:#9fbaff }

  .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; padding:8px 10px 16px; }
  .day{
    position:relative; aspect-ratio:1/1; border-radius:18px;
    display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:1.02rem; letter-spacing:.2px; color:#e7ecff;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
    border:1px solid var(--border); cursor:pointer; touch-action:manipulation; transition: var(--transition);
  }
  .day:hover{ transform: translateY(-2px) scale(1.05); border-color: rgba(123, 123, 255, 0.3); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
  .day:focus { outline: none; box-shadow: var(--focus-glow); }
  .day.out{ color:#6b728c; opacity:.8; }
  .day.weekend{ color:#dfe6ff; background:linear-gradient(180deg, rgba(124,140,255,.08), rgba(255,255,255,.03)); }
  .ring-today{
    position:absolute; inset:6px; border-radius:14px;
    border:2px solid var(--ring); pointer-events:none; box-shadow: 0 0 0 6px rgba(123,123,255,.10);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(123, 123, 255, 0.4); } 70% { box-shadow: 0 0 0 8px rgba(123, 123, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(123, 123, 255, 0); } }
  .day.selected{
    color:#10131b;
    background: radial-gradient(240px 160px at 50% -30%, rgba(48,224,161,.38), transparent 60%),
                radial-gradient(220px 140px at 20% 120%, rgba(123,123,255,.38), transparent 55%),
                #e9f0ff;
    border-color: rgba(123,123,255,.45);
    box-shadow: 0 8px 28px rgba(0,0,0,.30), inset 0 0 0 2px rgba(123,123,255,.20);
    transform: scale(1.05);
  }
  .day[data-maxurg="high"]{ box-shadow: inset 0 0 0 2px rgba(255,97,97,.35), 0 10px 26px rgba(255,97,97,.12); animation: alert-pulse 2s infinite; }
  @keyframes alert-pulse { 0%{box-shadow: inset 0 0 0 2px rgba(255,97,97,.35), 0 10px 26px rgba(255,97,97,.12)} 50%{box-shadow: inset 0 0 0 2px rgba(255,97,97,.5), 0 10px 26px rgba(255,97,97,.2)} 100%{box-shadow: inset 0 0 0 2px rgba(255,97,97,.35), 0 10px 26px rgba(255,97,97,.12)} }
  .day[data-maxurg="med"] { box-shadow: inset 0 0 0 2px rgba(255,209,87,.30), 0 10px 26px rgba(255,209,87,.10); }
  .day[data-maxurg="low"] { box-shadow: inset 0 0 0 2px rgba(99,243,167,.28), 0 10px 26px rgba(99,243,167,.08); }
  .day[data-maxurg="past"]{ box-shadow: inset 0 0 0 2px rgba(147,160,181,.26); }
  .badges{ position:absolute; left:6px; bottom:6px; display:flex; gap:4px; }
  .dot{ width:7px; height:7px; border-radius:999px; transition: var(--transition); }
  .dot.high{ background:var(--u-high); box-shadow:0 0 0 3px rgba(255,101,101,.16); }
  .dot.med { background:var(--u-med);  box-shadow:0 0 0 3px rgba(255,211,100,.16); }
  .dot.low { background:var(--u-low);  box-shadow:0 0 0 3px rgba(102,245,160,.16); }
  .dot.past{ background:var(--u-past); box-shadow:0 0 0 3px rgba(147,160,181,.16); }

  /* sheet */
  .sheet{ position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1); z-index:50; padding-bottom: env(safe-area-inset-bottom); }
  .sheet.open{ transform:translateY(0) }
  .panel{
    background: linear-gradient(180deg, rgba(18,22,33,.98), rgba(10,12,18,.98));
    backdrop-filter: blur(20px);
    border-top-left-radius: 26px; border-top-right-radius: 26px;
    border:1px solid var(--border); box-shadow: var(--shadow);
    padding:16px 16px 24px; max-width:520px; margin:0 auto;
  }
  .dragbar{ width:52px; height:6px; background:#2e3342; border-radius:999px; margin:6px auto 16px; cursor: grab; transition: var(--transition); }
  .dragbar:active { cursor: grabbing; background: #3e4352; }
  .panel h3{ margin:6px 0 4px; font-size:1.1rem; font-weight: 700; }
  .subtitle{ color:var(--muted); font-size:.86rem; margin-bottom: 16px; }

  /* barra rápida */
  .quick{ display:grid; grid-template-columns:1fr auto auto; gap:10px; margin:16px 0 10px; align-items:center; }
  .input{
    height:48px; background:#0e1118; border:1px solid var(--border); color:var(--text);
    border-radius:14px; padding:12px 16px; font:inherit; outline:none; width:100%; transition: var(--transition); font-size: 0.95rem;
  }
  .input:focus{ border-color: rgba(124,140,255,.65); box-shadow: 0 0 0 4px rgba(124,140,255,.15); background: #0d1017; }
  .control{ display:flex; align-items:center; gap:8px; height:48px; padding:0 12px; border-radius:14px; border:1px solid var(--border); background:#0f1118; color:#dbe4ff; transition: var(--transition); }
  .control:focus-within { border-color: rgba(124,140,255,.45); box-shadow: 0 0 0 3px rgba(124,140,255,.12); }
  .control select, .control input[type="time"]{ background:none; border:0; color:inherit; font:inherit; outline:none; font-size: 0.9rem; cursor: pointer; }
  .control small{ color:var(--muted) }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 14px; }
  .chip-btn{
    background:#0f1118; border:1px solid var(--border); color:#bcd0ff; border-radius:999px;
    padding:8px 14px; font-size:.82rem; cursor:pointer; transition: var(--transition);
  }
  .chip-btn:hover, .chip-btn:focus{ color:#fff; background: rgba(123, 123, 255, 0.15); border-color: rgba(123, 123, 255, 0.4); transform: translateY(-2px); }

  .preview{
    font-size:.86rem; color:#c9d7ff; background:#0f131d; border:1px solid var(--border);
    border-radius:12px; padding:12px 14px; margin: 10px 0 16px; transition: var(--transition);
  }
  .preview:empty { display: none; }

  .btn{
    height:50px; padding:0 20px; border-radius:14px; font-weight:800; cursor:pointer; border:0;
    background: linear-gradient(90deg, #27d8b7, #8ea0ff); color:#031a15; box-shadow: 0 14px 28px rgba(19,190,160,.30);
    transition: var(--transition); font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn:hover, .btn:focus { transform: translateY(-2px); box-shadow: 0 16px 32px rgba(19,190,160,.4); }
  .btn:active { transform: translateY(0); }
  .btn.secondary{ background:#161a24; color:var(--muted); border:1px solid var(--border); box-shadow:none; }
  .btn.secondary:hover, .btn.secondary:focus { background: #1a1e2a; color: #e2e9ff; border-color: rgba(123, 123, 255, 0.4); }

  /* lista de eventos */
  .ev-list{ display:flex; flex-direction:column; gap:12px; margin-top:16px; max-height: 40vh; overflow-y: auto; padding-right: 4px; }
  .ev-list::-webkit-scrollbar { width: 6px; }
  .ev-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
  .ev-list::-webkit-scrollbar-thumb { background: rgba(123,123,255,0.3); border-radius: 10px; }
  .ev-list::-webkit-scrollbar-thumb:hover { background: rgba(123,123,255,0.5); }

  .ev{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    border:1px solid var(--border); border-radius:16px; padding:14px;
    display:flex; gap:12px; align-items:center; transition: var(--transition);
  }
  .ev:hover { transform: translateY(-2px); border-color: rgba(123, 123, 255, 0.3); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
  .ev .time{ font-weight:700; font-size:.92rem; color:#cdd6ff; min-width:62px; font-feature-settings: "tnum"; }
  .ev .title{ font-size:.98rem; line-height: 1.4; }
  .ev .meta{ margin-left:auto; font-size:.78rem; color: var(--muted); text-align: right; min-width: 70px; }
  .ev.done .title{ text-decoration: line-through; opacity:.7; }
  .ev[data-urg="high"]{ border-left:5px solid var(--u-high); background:linear-gradient(180deg, rgba(255,101,101,.10), transparent); }
  .ev[data-urg="med"] { border-left:5px solid var(--u-med);  background:linear-gradient(180deg, rgba(255,211,100,.10), transparent); }
  .ev[data-urg="low"] { border-left:5px solid var(--u-low);  background:linear-gradient(180deg, rgba(102,245,160,.10), transparent); }
  .ev[data-urg="past"]{ border-left:5px solid var(--u-past); background:linear-gradient(180deg, rgba(147,160,181,.10), transparent); }

  .mini{ height:36px; width:36px; padding:0; border-radius:10px; border:1px solid var(--border); background:#10131b; color:#fff; cursor:pointer; display: grid; place-items: center; transition: var(--transition); }
  .mini:hover, .mini:focus { transform: scale(1.1); border-color: rgba(123, 123, 255, 0.4); }
  .mini.danger{ border-color: rgba(255,101,101,.4); background: rgba(255,101,101,0.1); }
  .mini.danger:hover, .mini.danger:focus { background: rgba(255,101,101,0.2); }
  .mini.good{ border-color: rgba(102,245,160,.4); color:#66f5a0; background: rgba(102,245,160,0.1); }
  .mini.good:hover, .mini.good:focus { background: rgba(102,245,160,0.2); }

  .fab{
    position:fixed; right:16px; bottom: calc(env(safe-area-inset-bottom) + 16px);
    display:flex; align-items:center; gap:10px;
    height:56px; padding:0 20px 0 16px; border-radius:18px;
    background:linear-gradient(90deg, #2be7c2, #8ea0ff); color:#041a16; font-weight:800; letter-spacing:.2px;
    box-shadow: 0 16px 36px rgba(46, 214, 186, .35); cursor:pointer; z-index:40; transition: var(--transition);
  }
  .fab:hover, .fab:focus { transform: translateY(-4px) scale(1.05); box-shadow: 0 20px 40px rgba(46, 214, 186, .5); }
  .fab:active { transform: translateY(0) scale(1); }

  .toast{
    position:fixed; left:50%; bottom: calc(env(safe-area-inset-bottom) + 84px);
    transform: translateX(-50%) translateY(20px);
    background: #10141d; color:#d8e0ff;
    border:1px solid var(--border); padding:12px 18px;
    border-radius:12px; box-shadow: var(--shadow);
    opacity:0; transition: .3s ease; z-index:60;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
  .errorbar{
    position:fixed; left:16px; right:16px; top:16px;
    z-index:100; background:#3a1010; border:1px solid #ff6b6b; color:#ffdcdc;
    padding:12px 16px; border-radius:12px; display: flex; align-items: center; gap: 10px;
  }

  /* responsivo */
  @media (max-width: 380px) {
    .quick { grid-template-columns: 1fr; gap: 12px; }
    .title { flex-direction: column; gap: 6px; }
    .weekdays { font-size: 0.75rem; }
    .day { font-size: 0.9rem; border-radius: 14px; }
  }
  @media (min-width:521px){
    body{ display:grid; place-items:center;
      background: radial-gradient(1200px 700px at 50% -260px, #151827 20%, var(--bg) 60%);
    }
  }
</style>
</head>
<body class="bg-blobs">
  <div class="app">
    <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <button class="round" id="prevBtn" aria-label="Mes anterior">‹</button>
        <div class="title">
          <span class="month-year" id="monthLabel">—</span>
          <button class="chip" id="todayBtn" aria-label="Ir a hoy">Hoy</button>
          <button class="chip" id="installBtn" style="display:none">Instalar</button>
          <span class="streak" id="streakLabel">🔥 0</span>
        </div>
        <button class="round" id="nextBtn" aria-label="Mes siguiente">›</button>
      </div>
    </div>

    <div class="card">
      <div class="weekdays" id="weekdays"></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <button class="fab" id="fab" title="Nuevo recordatorio"><span class="plus">＋</span> Nuevo</button>

  <!-- Sheet -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div class="dragbar" id="dragbar"></div>
      <h3 id="sheetDate">—</h3>
      <div class="subtitle">Recordatorios de este día</div>

      <!-- barra rápida -->
      <div class="quick">
        <input class="input" id="evTitle" type="text" placeholder="📝 Ej: 'Dentista 14:30 10 min antes' o 'en 2h comprar pan'">
        <div class="control" title="Hora"><small>🕒</small><input id="evTime" type="time" value="09:00"></div>
        <div class="control" title="Aviso"><small>🔔</small>
          <select id="evOffset">
            <option value="0">a la hora</option><option value="5">5m</option><option value="10">10m</option>
            <option value="15">15m</option><option value="30">30m</option><option value="60">1h</option>
            <option value="120">2h</option><option value="1440">1d</option>
          </select>
        </div>
      </div>

      <div class="chips" id="quickChips"></div>
      <div class="preview" id="previewText">—</div>

      <div class="ev-list" id="evList"></div>

      <div style="display:flex; gap:10px; margin-top:16px">
        <button class="btn" id="saveBtn" style="flex:1">💾 Guardar</button>
        <button class="btn secondary" id="closeSheet">Cerrar</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => { try{ initCalendar(); }catch(e){ fatal(e); } });

function fatal(err){
  console.error(err);
  const bar=document.createElement('div');
  bar.className='errorbar';
  bar.innerHTML=`<strong>⚠️ Error en el calendario:</strong> ${err.message||err}`;
  document.body.appendChild(bar);
}
function toast(msg, icon = "✅"){
  const t=document.createElement('div');
  t.className='toast';
  t.innerHTML = `${icon} ${msg}`;
  document.body.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),250); }, 2000);
}

/* ===== Calendario ===== */
function initCalendar(){
  const ids=['monthLabel','weekdays','grid','prevBtn','nextBtn','todayBtn','sheet','sheetDate','evList','evTitle','evTime','evOffset','saveBtn','closeSheet','fab','dragbar','streakLabel','quickChips','previewText'];
  const $=id=>document.getElementById(id);
  const els=Object.fromEntries(ids.map(id=>[id,$(id)]));
  if (Object.values(els).some(v=>!v)) throw new Error('Faltan elementos del DOM');

  const WEEK_START='monday', locale='es-MX';
  const URG={high:'high',med:'med',low:'low',past:'past'};
  const thresholds={ highMs:60*60*1000, medMs:24*60*60*1000 };
  const state={ view:stripTime(new Date()), selected:stripTime(new Date()), touch:null, storeKey:'cal_events_v3_smart' };

  // fechas & helpers
  function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function weekdayIndex(date){ const iso=date.getDay(); return WEEK_START==='monday' ? (iso+6)%7 : iso; }
  function formatMonthYear(d){ const m=new Intl.DateTimeFormat(locale,{month:'long'}).format(d); return (m[0].toUpperCase()+m.slice(1))+' '+d.getFullYear(); }
  function formatLong(d){ const s=new Intl.DateTimeFormat(locale,{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(d); return s[0].toUpperCase()+s.slice(1); }
  function toDateTime(baseDate, hhmm){ const [h,m]=(hhmm||'00:00').split(':').map(Number); return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h||0, m||0, 0, 0); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function relTime(ms){ const s=Math.round(ms/1000), past=s<0, abs=Math.abs(s), min=60, hr=3600, day=86400; let n,u; if(abs<min){n=abs;u='seg';} else if(abs<hr){n=Math.round(abs/min);u='min';} else if(abs<day){n=Math.round(abs/hr);u='h';} else {n=Math.round(abs/day);u='d';} return past?`hace ${n} ${u}`:`en ${n} ${u}`; }
  function urgencyFor(remindAtMs, done){ if (done) return URG.past; const diff=remindAtMs - Date.now(); if (diff<0) return URG.past; if (diff<=thresholds.highMs) return URG.high; if (diff<=thresholds.medMs) return URG.med; return URG.low; }

  // storage
  function loadEvents(){ try{ return JSON.parse(localStorage.getItem(state.storeKey)||'{}'); }catch{ return {}; } }
  function saveEvents(map){ localStorage.setItem(state.storeKey, JSON.stringify(map)); }

  // NLP ligera
  const dowMap={domingo:0,lunes:1,martes:2,miércoles:3,miercoles:3,jueves:4,viernes:5,sábado:6,sabado:6};
  function nextDow(from, dow){ const d=new Date(from); const diff=((dow - d.getDay()) + 7) % 7 || 7; d.setDate(d.getDate()+diff); return stripTime(d); }
  function parseSmart(text, selectedDate, currentHHMM, currentOffsetMin){
    let t=text.toLowerCase(); let title=text; let date=selectedDate; let hhmm=currentHHMM; let offsetMin=currentOffsetMin; let direct=false;
    let m=t.match(/(\d+)\s*(?:min|mins|minuto|minutos)\s*antes\b/);
    if (m){ offsetMin=parseInt(m[1],10); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    m=t.match(/\ben\s+(\d+)\s*(h|hr|hrs|hora|horas|min|mins|minuto|minutos)\b/);
    if (m){ const n=parseInt(m[1],10); const unit=m[2]; let ms=/h|hr|hrs|hora/.test(unit)?n*3600000:n*60000; const when=new Date(Date.now()+ms); date=stripTime(when); hhmm=when.toTimeString().slice(0,5); offsetMin=0; direct=true; t=t.replace(m[0],''); title=title.replace(m[0],''); }
    if (!direct){
      if (/\bpasado\s+mañana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+2); date=stripTime(d); t=t.replace(/pasado\s+mañana/,''); title=title.replace(/pasado\s+mañana/i,''); }
      else if (/\bmañana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+1); date=stripTime(d); t=t.replace(/mañana/,''); title=title.replace(/mañana/i,''); }
      else if (/\bhoy\b/.test(t)){ date=stripTime(new Date()); t=t.replace(/hoy/,''); title=title.replace(/hoy/i,''); }
      let w=t.match(/pr[óo]xim[oa]?\s+(domingo|lunes|martes|mi[eé]rcoles|miercoles|jueves|viernes|s[áa]bado|sabado)/);
      if (w){ const dname=w[1].normalize("NFD").replace(/[\u0300-\u036f]/g,''); date=nextDow(new Date(), dowMap[dname]); t=t.replace(w[0],''); title=title.replace(new RegExp(w[0],'i'),''); }
    }
    m=t.match(/\b(?:a\s+las\s+)?(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\b/);
    if (m){ let H=parseInt(m[1],10), M=m[2]?parseInt(m[2],10):0, ap=m[3]; if (ap){ if (ap==='pm' && H<12) H+=12; if (ap==='am' && H===12) H=0; } H=Math.max(0,Math.min(23,H)); M=Math.max(0,Math.min(59,M)); hhmm=String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    title=title.replace(/\s{2,}/g,' ').trim(); return { title: title||text, date, hhmm, offsetMin };
  }

  function computeStreak(map){
    let streak=0; const today=stripTime(new Date()); let d=new Date(today);
    while(true){ const key=ymd(d), list=(map[key]||[]), hasPending=list.some(e=>!e.done && e.remindAt>0);
      if (list.length && !hasPending){ streak++; d.setDate(d.getDate()-1); continue; } break; }
    return streak;
  }

  function renderWeekdays(){
    const daysMon=['L','M','X','J','V','S','D'], daysSun=['D','L','M','X','J','V','S'];
    const list=(WEEK_START==='monday')?daysMon:daysSun;
    const html=list.map((d,i)=>`<div${(i>=5)?' style="color:#9fbaff"':''}>${d}</div>`).join('');
    els.weekdays.innerHTML=html;
  }

  function render(){
    els.monthLabel.textContent=formatMonthYear(state.view);
    const map=loadEvents();
    els.streakLabel.textContent='🔥 '+computeStreak(map);
    renderGrid(map);
  }

  function renderGrid(data){
    els.grid.innerHTML='';
    const first=firstOfMonth(state.view), Y=first.getFullYear(), M=first.getMonth(), pad=weekdayIndex(first), total=42;
    for(let i=0;i<total;i++){
      const dayNum=i - pad + 1, thisDate=new Date(Y, M, dayNum), inMonth=thisDate.getMonth()===M;
      const cell=document.createElement('button');
      cell.className='day' + (inMonth?'':' out') + (([0,6].includes(thisDate.getDay()))?' weekend':'');
      cell.dataset.date=ymd(thisDate);
      cell.setAttribute('aria-label', new Intl.DateTimeFormat('es-MX',{dateStyle:'full'}).format(thisDate));
      cell.textContent=thisDate.getDate();

      if (sameDay(thisDate,new Date())){ const ring=document.createElement('div'); ring.className='ring-today'; cell.appendChild(ring); }
      if (sameDay(thisDate,state.selected)) cell.classList.add('selected');

      const dots=document.createElement('div'); dots.className='badges';
      const list=data[ ymd(thisDate) ] || [];
      if (list.length){
        const urgSet=new Set(); let max='low';
        list.forEach(it=>{
          const u=urgencyFor(it.remindAt, it.done);
          if (!it.done) urgSet.add(u);
          if (u==='high') max='high'; else if (u==='med' && max!=='high') max='med'; else if (u==='past' && max!=='high' && max!=='med') max='past';
        });
        if (urgSet.size) cell.dataset.maxurg=max;
        ['high','med','low','past'].filter(u=>urgSet.has(u)).slice(0,3).forEach(u=>{
          const dot=document.createElement('span'); dot.className='dot '+u; dots.appendChild(dot);
        });
      }
      cell.appendChild(dots);
      cell.addEventListener('click', ()=>{ state.selected=stripTime(thisDate); openSheet(); renderGrid(loadEvents()); });
      els.grid.appendChild(cell);
    }
  }

  function openSheet(){
    els.sheet.classList.add('open');
    els.sheetDate.textContent=formatLong(state.selected);
    paintDayEvents();
    buildQuickChips();
    updatePreview();
    setTimeout(()=>{ if(!els.evTitle.value) els.evTitle.focus(); }, 120);
  }
  function closeSheetFn(){ els.sheet.classList.remove('open'); }
  els.closeSheet.addEventListener('click', closeSheetFn);

  function buildQuickChips(){
    const now=new Date();
    const chips=[
      {label:'+30m', act:()=> setFromRelative(30)},
      {label:'+1h', act:()=> setFromRelative(60)},
      {label:'Hoy 18:00', act:()=> setDateTime(stripTime(new Date()), '18:00')},
      {label:'Mañana 9:00', act:()=> {const d=new Date(); d.setDate(d.getDate()+1); setDateTime(stripTime(d),'09:00');}},
      {label:'Próx. Lunes 9:00', act:()=> setDateTime(nextDow(new Date(),1),'09:00')},
    ];
    const box=document.getElementById('quickChips');
    box.innerHTML='';
    chips.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip-btn';
      b.textContent=c.label;
      b.addEventListener('click', ()=>{ c.act(); updatePreview(); });
      box.appendChild(b);
    });
    function setFromRelative(min){ const when=new Date(now.getTime()+min*60000); setDateTime(stripTime(when), when.toTimeString().slice(0,5)); els.evOffset.value='0'; }
    function setDateTime(d, hhmm){ state.selected=d; els.sheetDate.textContent=formatLong(d); els.evTime.value=hhmm; }
  }

  function paintDayEvents(){
    if (!els.sheet.classList.contains('open')) return;
    const data=loadEvents(), key=ymd(state.selected), items=data[key]||[];
    els.evList.innerHTML = items.length ? '' : `<div class="subtitle" style="margin-top:6px">Sin recordatorios todavía.</div>`;
    items.map((it,idx)=>({it,idx,u:urgencyFor(it.remindAt,it.done)}))
      .sort((a,b)=>({high:0,med:1,low:2,past:3}[a.u]-({high:0,med:1,low:2,past:3}[b.u])))
      .forEach(({it,idx,u})=>{
        const row=document.createElement('div'); row.className='ev'; if (it.done) row.classList.add('done'); row.dataset.urg=u;
        const when=new Date(it.remindAt), diff=when.getTime()-Date.now(), rel=relTime(diff);
        const off=it.offsetMin ? ` · ${it.offsetMin} min antes` : '';
        row.innerHTML=`
          <div class="time">${it.time||'--:--'}</div>
          <div class="title">${escapeHtml(it.title||'Sin título')}</div>
          <div class="meta">${rel}${off}</div>
          <div style="margin-left:10px; display:flex; gap:6px">
            <button class="mini good" data-done="${idx}" title="Marcar hecho">✔</button>
            <button class="mini" data-snooze="${idx}" title="Posponer 10 min">⏰+10m</button>
            <button class="mini danger" data-del="${idx}" title="Eliminar">🗑</button>
          </div>`;
        row.querySelector('[data-del]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-del')); const map=loadEvents(); map[key].splice(i,1); saveEvents(map); paintDayEvents(); render();
        });
        row.querySelector('[data-done]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-done')); const map=loadEvents(); map[key][i].done=!map[key][i].done; saveEvents(map); paintDayEvents(); render();
          toast('¡Bien hecho! ✔');
        });
        row.querySelector('[data-snooze]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-snooze')); const map=loadEvents(); const now=Date.now();
          map[key][i].remindAt = now + 10*60000;
          const d=new Date(map[key][i].remindAt); map[key][i].date=ymd(d); map[key][i].time=d.toTimeString().slice(0,5);
          saveEvents(map);
          if (map[key][i].date!==key){
            const moved=map[key].splice(i,1)[0];
            map[moved.date]=map[moved.date]||[]; map[moved.date].push(moved);
            saveEvents(map);
          }
          paintDayEvents(); render();
          toast('Pospuesto 10 min ⏰');
        });
        els.evList.appendChild(row);
      });
  }

  // Vista previa en vivo
  function updatePreview(){
    const parsed = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    const eventAt = toDateTime(parsed.date, parsed.hhmm);
    const remindAt = new Date(eventAt.getTime() - parsed.offsetMin*60000);
    const whenTxt = new Intl.DateTimeFormat('es-MX',{weekday:'short', day:'numeric', month:'short'}).format(parsed.date);
    const offsetTxt = parsed.offsetMin ? ` · 🔔 ${parsed.offsetMin}m antes` : '';
    els.previewText.textContent = `📌 ${parsed.title || '—'}  ·  ⏱️ ${whenTxt} ${parsed.hhmm}${offsetTxt}`;
  }
  ['keyup','change','input'].forEach(ev=>{
    document.getElementById('evTitle').addEventListener(ev, updatePreview);
    document.getElementById('evTime').addEventListener(ev, updatePreview);
    document.getElementById('evOffset').addEventListener(ev, updatePreview);
  });

  // Guardar
  els.saveBtn.addEventListener('click', ()=>{
    const parsed = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    if (!parsed.title){ els.evTitle.focus(); return; }
    state.selected = parsed.date;
    const eventAt = toDateTime(parsed.date, parsed.hhmm);
    const remindAt = new Date(eventAt.getTime() - parsed.offsetMin*60000);
    const map=loadEvents(); const key=ymd(parsed.date);
    map[key]=map[key]||[];
    map[key].push({ title: parsed.title, date:key, time:parsed.hhmm, offsetMin:parsed.offsetMin, eventAt:eventAt.getTime(), remindAt:remindAt.getTime(), createdAt:Date.now(), done:false });
    saveEvents(map);
    els.evTitle.value=''; els.evTime.value=parsed.hhmm; els.evOffset.value=String(parsed.offsetMin);
    els.sheetDate.textContent=formatLong(parsed.date); updatePreview(); paintDayEvents(); render();
    toast('Recordatorio guardado');
  });

  // FAB & navegación
  els.fab.addEventListener('click', ()=>{ if (!els.sheet.classList.contains('open')) openSheet(); els.evTitle.focus(); });
  els.prevBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()-1, 1); render(); });
  els.nextBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()+1, 1); render(); });
  els.todayBtn.addEventListener('click', ()=>{ const t=stripTime(new Date()); state.view=new Date(t.getFullYear(), t.getMonth(), 1); state.selected=t; render(); openSheet(); });

  // Gestos
  els.grid.addEventListener('touchstart', e=>{ state.touch={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()}; }, {passive:true});
  els.grid.addEventListener('touchend', e=>{
    if (!state.touch) return; const dx=e.changedTouches[0].clientX-state.touch.x, dy=e.changedTouches[0].clientY-state.touch.y, dt=Date.now()-state.touch.t;
    if (Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy) && dt<450){ (dx<0)?els.nextBtn.click():els.prevBtn.click(); }
    state.touch=null;
  });

  // Drag para sheet
  let dragStartY=null;
  document.getElementById('dragbar').addEventListener('touchstart', e=>{ dragStartY=e.touches[0].clientY; }, {passive:true});
  document.getElementById('dragbar').addEventListener('touchend', e=>{ if(dragStartY==null) return; const dy=e.changedTouches[0].clientY-dragStartY; if (dy>40) els.closeSheet.click(); dragStartY=null; });

  // Efecto de scroll en topbar
  window.addEventListener('scroll', () => {
    const topbar = document.getElementById('topbar');
    if (window.scrollY > 10) topbar.classList.add('scrolled'); else topbar.classList.remove('scrolled');
  });

  // init
  (function start(){
    renderWeekdays(); render();
    if (els.sheet.classList.contains('open')) updatePreview();
    setInterval(()=>{ render(); if (els.sheet.classList.contains('open')) { paintDayEvents(); updatePreview(); } }, 60*1000);
  })();
}
</script>
</body>
</html>
