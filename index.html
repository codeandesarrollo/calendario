<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario ¬∑ Recordatorios</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<meta name="theme-color" content="#0e1118" />

<style>
  :root{
    --bg:#07090e; --card:#111522; --text:#f4f7ff; --muted:#a9b3c5; --border:rgba(255,255,255,.08);
    --accent-a:#2be7c2; --accent-b:#8ea0ff; --accent-c:#ff77e1; --ring:rgba(123,123,255,.55);
    --u-high:#ff6161; --u-med:#ffd157; --u-low:#63f3a7; --u-past:#93a0b5;
    --shadow:0 18px 45px rgba(0,0,0,.45); --touch:48px; --radius:22px;
    --transition: all .25s cubic-bezier(.4,0,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:"Sora",system-ui,-apple-system,Segoe UI,Roboto,"Inter",sans-serif;
    background: radial-gradient(900px 560px at 50% -220px, #151827 20%, var(--bg) 60%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  .bg-blobs::before,.bg-blobs::after{
    content:""; position:fixed; inset:auto; z-index:-1; filter:blur(70px); opacity:.45; pointer-events:none;
    width:340px; height:340px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #1de9b6, transparent 60%);
    animation: float1 16s ease-in-out infinite;
  }
  .bg-blobs::after{
    width:380px; height:380px; right:-120px; bottom:-140px; opacity:.35;
    background: radial-gradient(circle at 70% 40%, #7c8cff, transparent 60%);
    animation: float2 22s ease-in-out infinite;
  }
  @keyframes float1{0%,100%{transform:translate(-60px,-40px)}50%{transform:translate(10px,8px)}}
  @keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(-30px,30px)}}

  .app{min-height:100dvh; max-width:520px; margin:0 auto; display:flex; flex-direction:column;}

  /* Topbar */
  .topbar{ position:sticky; top:0; z-index:10; background:rgba(7,9,14,.9); backdrop-filter: blur(12px); border-bottom:1px solid var(--border); }
  .topbar-inner{ display:flex; align-items:center; gap:10px; padding: calc(env(safe-area-inset-top) + 10px) 12px 8px; }
  .round{ width:var(--touch); height:var(--touch); display:grid; place-items:center; border-radius:14px; border:1px solid var(--border); background:#0b0f18; color:var(--text); font-weight:600; transition:var(--transition) }
  .round:active{ transform:scale(.96) }
  .title{ flex:1; text-align:center; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:700 }
  .month-year{ font-size:1.1rem; background: linear-gradient(90deg,var(--accent-a),var(--accent-b),var(--accent-c)); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .chip{ border:1px solid var(--border); color:#cfe1ff; padding:6px 12px; border-radius:999px; font-size:.82rem; background:#0b0f18 }

  /* Calendario */
  .card{
    margin:12px; padding:12px; border-radius:22px;
    background: linear-gradient(var(--card), var(--card)) padding-box,
               linear-gradient(135deg, rgba(48,224,161,.28), rgba(123,123,255,.22), rgba(255,119,225,.22)) border-box;
    border:1px solid transparent; box-shadow: var(--shadow);
  }
  .weekdays{ display:grid; grid-template-columns:repeat(7,1fr); padding:8px 8px 10px; gap:6px; font-size:.78rem; color:#c6ceea; text-align:center; font-weight:600 }
  .weekdays div:nth-child(6), .weekdays div:nth-child(7){ color:#9fbaff }
  .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; padding:6px 8px 12px; }
  .day{ position:relative; aspect-ratio:1/1; border-radius:16px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.98rem; color:#e7ecff; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid var(--border); }
  .day.out{ color:#6b728c; opacity:.85 }
  .day.weekend{ background:linear-gradient(180deg, rgba(124,140,255,.06), rgba(255,255,255,.02)) }
  .day.selected{ color:#0d1620; background:#e9f0ff; border-color:rgba(123,123,255,.45); box-shadow:0 6px 20px rgba(0,0,0,.28) }
  .ring-today{ position:absolute; inset:5px; border-radius:14px; border:2px solid var(--ring); pointer-events:none; box-shadow:0 0 0 6px rgba(123,123,255,.10) }
  .badges{ position:absolute; left:6px; bottom:6px; display:flex; gap:4px }
  .dot{ width:6px; height:6px; border-radius:999px }
  .dot.high{ background:var(--u-high) } .dot.med{ background:var(--u-med) } .dot.low{ background:var(--u-low) } .dot.past{ background:var(--u-past) }
  .day[data-maxurg="high"]{ box-shadow: inset 0 0 0 2px rgba(255,97,97,.35) }
  .day[data-maxurg="med"]{  box-shadow: inset 0 0 0 2px rgba(255,209,87,.30) }
  .day[data-maxurg="low"]{  box-shadow: inset 0 0 0 2px rgba(99,243,167,.28) }
  .day[data-maxurg="past"]{ box-shadow: inset 0 0 0 2px rgba(147,160,181,.26) }

  /* FAB */
  .fab{
    position:fixed; right:12px; bottom: calc(env(safe-area-inset-bottom) + 14px);
    display:flex; align-items:center; gap:8px; height:54px; padding:0 18px 0 14px; border-radius:16px;
    background:linear-gradient(90deg, var(--accent-a), var(--accent-b)); color:#041a16; font-weight:800; letter-spacing:.2px;
    box-shadow:0 14px 34px rgba(46,214,186,.35); z-index:40;
  }

  /* Toast */
  .toast{ position:fixed; left:50%; bottom: calc(env(safe-area-inset-bottom) + 78px); transform: translateX(-50%); background:#10141d; color:#d8e0ff; border:1px solid var(--border); padding:12px 16px; border-radius:12px; box-shadow: var(--shadow); opacity:0; transition:.25s; z-index:60 }
  .toast.show{ opacity:1; }

  /* ===== Sheet (mobile-first) ===== */
  .sheet{ position:fixed; inset:auto 0 0 0; transform:translateY(100%); transition: transform .35s cubic-bezier(.22,1,.36,1); z-index:50; }
  .sheet.open{ transform:translateY(0) }
  .panel{
    background:linear-gradient(180deg, rgba(18,22,33,.98), rgba(10,12,18,.98));
    border-top-left-radius:24px; border-top-right-radius:24px; border:1px solid var(--border);
    max-width:520px; margin:0 auto; box-shadow: var(--shadow);
    display:flex; flex-direction:column; max-height:92dvh; /* casi fullscreen */
    padding-bottom: max(12px, env(safe-area-inset-bottom));
  }
  .dragbar{ width:56px; height:6px; background:#2e3342; border-radius:999px; margin:8px auto 14px }
  .panel h3{ margin:8px 14px 2px; font-size:1.15rem; font-weight:700 }
  .subtitle{ color:var(--muted); font-size:.86rem; margin:0 14px 12px }

  /* Composer */
  .quick{ display:grid; grid-template-columns:1fr; gap:10px; margin:0 14px }
  .input{
    height:48px; background:#0e1118; border:1px solid var(--border); color:var(--text);
    border-radius:14px; padding:12px 14px; font:inherit; outline:none; width:100%;
  }
  .field-row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
  .control{
    height:48px; display:flex; align-items:center; gap:8px; padding:0 12px;
    border-radius:14px; border:1px solid var(--border); background:#0f1118; color:#dbe4ff;
  }
  .control input[type="time"], .control select{
    appearance:none; -webkit-appearance:none; background:none; border:0; outline:none; color:#e7edff; font:inherit; width:100%;
  }

  /* Chips: carrusel horizontal */
  .chips{ display:flex; gap:8px; overflow:auto hidden; margin:12px 14px 6px; padding-bottom:4px; scroll-snap-type:x proximity }
  .chips::-webkit-scrollbar{ height:6px } .chips::-webkit-scrollbar-thumb{ background:rgba(123,123,255,.3); border-radius:10px }
  .chip-btn{ white-space:nowrap; scroll-snap-align:start; background:#0f1118; border:1px solid var(--border); color:#bcd0ff; border-radius:999px; padding:8px 14px; font-size:.82rem }

  /* Preview compacto */
  .preview{
    margin:8px 14px 10px; padding:10px 12px; font-size:.9rem; color:#c9d7ff;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:12px;
  }

  /* Lista */
  .ev-list{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding:0 14px 6px; }
  .ev{
    position:relative; display:flex; align-items:center; gap:10px;
    padding:12px; border-radius:14px; border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
  }
  .ev::before{ /* acento lateral curvo */
    content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:14px 0 0 14px; background:linear-gradient(180deg, var(--accent-a), var(--accent-b));
  }
  .ev[data-urg="high"]::before{ background:linear-gradient(180deg,#ff9a9a,#ff6161) }
  .ev[data-urg="med"]::before{ background:linear-gradient(180deg,#ffe39a,#ffd157) }
  .ev[data-urg="low"]::before{ background:linear-gradient(180deg,#9ff7cf,#63f3a7) }
  .time{ font-weight:800; font-size:.92rem; color:#eaf2ff; min-width:58px }
  .title{ font-size:.98rem; line-height:1.35 }
  .meta{ margin-left:auto; font-size:.78rem; color:var(--muted); text-align:right; min-width:66px }
  .mini{ height:36px; width:36px; border-radius:10px; border:1px solid var(--border); background:#10131b; color:#fff }
  .mini.good{ border-color:rgba(102,245,160,.4); color:#66f5a0; background:rgba(102,245,160,.08) }
  .mini.danger{ border-color:rgba(255,101,101,.4); background:rgba(255,101,101,.08) }
  .ev.done .title{ text-decoration:line-through; opacity:.7 }

  /* Acciones sticky */
  .sheet-actions{
    position:sticky; bottom:0; margin-top:10px; padding:10px 14px 0; background:linear-gradient(180deg, transparent 0, rgba(12,14,20,.92) 28%);
    display:flex; gap:10px;
  }
  .btn{
    height:50px; border-radius:14px; border:0; font-weight:800; display:flex; align-items:center; justify-content:center; gap:8px;
  }
  #saveBtn{ flex:1; background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#041a16; box-shadow:0 12px 28px rgba(46,214,186,.28) }
  #closeSheet{ width:120px; background:#161a24; color:var(--muted); border:1px solid var(--border) }

  .errorbar{ position:fixed; left:12px; right:12px; top:12px; z-index:100; background:#3a1010; border:1px solid #ff6b6b; color:#ffdcdc; padding:12px 16px; border-radius:12px }

  @media (min-width:521px){
    body{ display:grid; place-items:center; background: radial-gradient(1200px 700px at 50% -260px, #151827 20%, var(--bg) 60%); }
  }
</style>
</head>
<body class="bg-blobs">
  <div class="app">
    <!-- Topbar -->
    <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <button class="round" id="prevBtn" aria-label="Mes anterior">‚Äπ</button>
        <div class="title">
          <span class="month-year" id="monthLabel">‚Äî</span>
          <button class="chip" id="todayBtn" aria-label="Ir a hoy">Hoy</button>
          <span class="chip" id="streakLabel">üî• 0</span>
        </div>
        <button class="round" id="nextBtn" aria-label="Mes siguiente">‚Ä∫</button>
      </div>
    </div>

    <!-- Calendario -->
    <div class="card">
      <div class="weekdays" id="weekdays"></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="fab" title="Nuevo recordatorio"><span class="plus">Ôºã</span> Nuevo</button>

  <!-- Sheet -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div class="dragbar" id="dragbar"></div>
      <h3 id="sheetDate">‚Äî</h3>
      <div class="subtitle">Recordatorios de este d√≠a</div>

      <!-- Composer -->
      <div class="quick">
        <input class="input" id="evTitle" type="text" placeholder="üìù Ej.: 'Dentista 14:30 10m antes' o 'en 2h comprar pan'">
        <div class="field-row">
          <div class="control" title="Hora"><small>üïí</small><input id="evTime" type="time" value="09:00" inputmode="numeric"></div>
          <div class="control" title="Aviso"><small>üîî</small>
            <select id="evOffset">
              <option value="0">a la hora</option><option value="5">5m</option><option value="10">10m</option>
              <option value="15">15m</option><option value="30">30m</option><option value="60">1h</option>
              <option value="120">2h</option><option value="1440">1d</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Chips -->
      <div class="chips" id="quickChips"></div>

      <!-- Preview -->
      <div class="preview" id="previewText">‚Äî</div>

      <!-- Lista -->
      <div class="ev-list" id="evList"></div>

      <!-- Acciones -->
      <div class="sheet-actions">
        <button class="btn" id="saveBtn">üíæ Guardar</button>
        <button class="btn" id="closeSheet">Cerrar</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => { try{ initCalendar(); }catch(e){ fatal(e); } });

function fatal(err){
  console.error(err);
  const bar=document.createElement('div');
  bar.className='errorbar';
  bar.innerHTML=`<strong>‚ö†Ô∏è Error en el calendario:</strong> ${err.message||err}`;
  document.body.appendChild(bar);
}
function toast(msg, icon = "‚úÖ"){
  const t=document.createElement('div'); t.className='toast'; t.textContent = `${icon} ${msg}`;
  document.body.appendChild(t); requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),250); }, 1800);
}

/* ===== Calendario ===== */
function initCalendar(){
  const ids=['monthLabel','weekdays','grid','prevBtn','nextBtn','todayBtn','sheet','sheetDate','evList','evTitle','evTime','evOffset','saveBtn','closeSheet','fab','dragbar','streakLabel','quickChips','previewText'];
  const $=id=>document.getElementById(id);
  const els=Object.fromEntries(ids.map(id=>[id,$(id)]));
  if (Object.values(els).some(v=>!v)) throw new Error('Faltan elementos del DOM');

  const WEEK_START='monday', locale='es-MX';
  const URG={high:'high',med:'med',low:'low',past:'past'};
  const thresholds={ highMs:60*60*1000, medMs:24*60*60*1000 };
  const state={ view:strip(new Date()), selected:strip(new Date()), touch:null, storeKey:'cal_events_v3_smart' };

  // helpers
  function strip(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function same(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function first(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function widx(date){ const iso=date.getDay(); return WEEK_START==='monday' ? (iso+6)%7 : iso; }
  function fmtMY(d){ const m=new Intl.DateTimeFormat(locale,{month:'long'}).format(d); return (m[0].toUpperCase()+m.slice(1))+' '+d.getFullYear(); }
  function fmtLong(d){ const s=new Intl.DateTimeFormat(locale,{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(d); return s[0].toUpperCase()+s.slice(1); }
  function toDT(base, hhmm){ const [h,m]=(hhmm||'00:00').split(':').map(Number); return new Date(base.getFullYear(), base.getMonth(), base.getDate(), h||0, m||0, 0, 0); }
  function esc(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function rel(ms){ const s=Math.round(ms/1000), past=s<0, abs=Math.abs(s), min=60, hr=3600, day=86400; let n,u; if(abs<min){n=abs;u='seg';} else if(abs<hr){n=Math.round(abs/min);u='min';} else if(abs<day){n=Math.round(abs/hr);u='h';} else {n=Math.round(abs/day);u='d';} return past?`hace ${n} ${u}`:`en ${n} ${u}`; }
  function urg(remMs, done){ if (done) return URG.past; const diff=remMs - Date.now(); if (diff<0) return URG.past; if (diff<=thresholds.highMs) return URG.high; if (diff<=thresholds.medMs) return URG.med; return URG.low; }

  // storage
  const load=()=>{ try{ return JSON.parse(localStorage.getItem(state.storeKey)||'{}'); }catch{ return {}; } };
  const save=(map)=> localStorage.setItem(state.storeKey, JSON.stringify(map));

  // NLP ligera
  const dmap={domingo:0,lunes:1,martes:2,mi√©rcoles:3,miercoles:3,jueves:4,viernes:5,s√°bado:6,sabado:6};
  const nextDow=(from, dow)=>{ const d=new Date(from); const diff=((dow - d.getDay()) + 7) % 7 || 7; d.setDate(d.getDate()+diff); return strip(d); };
  function parseSmart(text, selectedDate, currentHHMM, currentOffsetMin){
    let t=text.toLowerCase(); let title=text; let date=selectedDate; let hhmm=currentHHMM; let offsetMin=currentOffsetMin; let direct=false;
    let m=t.match(/(\d+)\s*(?:min|mins|minuto|minutos)\s*antes\b/);
    if (m){ offsetMin=parseInt(m[1],10); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    m=t.match(/\ben\s+(\d+)\s*(h|hr|hrs|hora|horas|min|mins|minuto|minutos)\b/);
    if (m){ const n=parseInt(m[1],10); const unit=m[2]; let ms=/h|hr|hrs|hora/.test(unit)?n*3600000:n*60000; const when=new Date(Date.now()+ms); date=strip(when); hhmm=when.toTimeString().slice(0,5); offsetMin=0; direct=true; t=t.replace(m[0],''); title=title.replace(m[0],''); }
    if (!direct){
      if (/\bpasado\s+ma√±ana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+2); date=strip(d); t=t.replace(/pasado\s+ma√±ana/,''); title=title.replace(/pasado\s+ma√±ana/i,''); }
      else if (/\bma√±ana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+1); date=strip(d); t=t.replace(/ma√±ana/,''); title=title.replace(/ma√±ana/i,''); }
      else if (/\bhoy\b/.test(t)){ date=strip(new Date()); t=t.replace(/hoy/,''); title=title.replace(/hoy/i,''); }
      let w=t.match(/pr[√≥o]xim[oa]?\s+(domingo|lunes|martes|mi[e√©]rcoles|miercoles|jueves|viernes|s[√°a]bado|sabado)/);
      if (w){ const dname=w[1].normalize("NFD").replace(/[\u0300-\u036f]/g,''); date=nextDow(new Date(), dmap[dname]); t=t.replace(w[0],''); title=title.replace(new RegExp(w[0],'i'),''); }
    }
    m=t.match(/\b(?:a\s+las\s+)?(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\b/);
    if (m){ let H=parseInt(m[1],10), M=m[2]?parseInt(m[2],10):0, ap=m[3]; if (ap){ if (ap==='pm' && H<12) H+=12; if (ap==='am' && H===12) H=0; } H=Math.max(0,Math.min(23,H)); M=Math.max(0,Math.min(59,M)); hhmm=String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    title=title.replace(/\s{2,}/g,' ').trim(); return { title: title||text, date, hhmm, offsetMin };
  }

  // streak
  function streak(map){
    let s=0; const today=strip(new Date()); let d=new Date(today);
    while(true){ const key=ymd(d), list=(map[key]||[]), hasPending=list.some(e=>!e.done && e.remindAt>0);
      if (list.length && !hasPending){ s++; d.setDate(d.getDate()-1); continue; } break; }
    return s;
  }

  function renderWeekdays(){
    const mon=['L','M','X','J','V','S','D'], sun=['D','L','M','X','J','V','S'];
    (WEEK_START==='monday'?mon:sun);
    const list=(WEEK_START==='monday'?mon:sun).map((d,i)=>`<div${(i>=5)?' style="color:#9fbaff"':''}>${d}</div>`).join('');
    els.weekdays.innerHTML=list;
  }

  function render(){
    els.monthLabel.textContent=fmtMY(state.view);
    const map=load();
    els.streakLabel.textContent='üî• '+streak(map);
    renderGrid(map);
  }

  function renderGrid(data){
    els.grid.innerHTML='';
    const f=first(state.view), Y=f.getFullYear(), M=f.getMonth(), pad=widx(f), total=42;
    for(let i=0;i<total;i++){
      const n=i - pad + 1, d=new Date(Y, M, n), inMonth=d.getMonth()===M;
      const cell=document.createElement('button');
      cell.className='day' + (inMonth?'':' out') + (([0,6].includes(d.getDay()))?' weekend':'');
      cell.dataset.date=ymd(d);
      cell.setAttribute('aria-label', new Intl.DateTimeFormat('es-MX',{dateStyle:'full'}).format(d));
      cell.textContent=d.getDate();
      if (same(d,new Date())){ const ring=document.createElement('div'); ring.className='ring-today'; cell.appendChild(ring); }
      if (same(d,state.selected)) cell.classList.add('selected');

      const dots=document.createElement('div'); dots.className='badges';
      const list=data[ ymd(d) ] || [];
      if (list.length){
        const urgSet=new Set(); let max='low';
        list.forEach(it=>{
          const u=urg(it.remindAt, it.done);
          if (!it.done) urgSet.add(u);
          if (u==='high') max='high'; else if (u==='med' && max!=='high') max='med'; else if (u==='past' && max!=='high' && max!=='med') max='past';
        });
        if (urgSet.size) cell.dataset.maxurg=max;
        ['high','med','low','past'].filter(u=>urgSet.has(u)).slice(0,3).forEach(u=>{
          const dot=document.createElement('span'); dot.className='dot '+u; dots.appendChild(dot);
        });
      }
      cell.appendChild(dots);
      cell.addEventListener('click', ()=>{ state.selected=strip(d); openSheet(); renderGrid(load()); });
      els.grid.appendChild(cell);
    }
  }

  function openSheet(){
    els.sheet.classList.add('open');
    els.sheetDate.textContent=fmtLong(state.selected);
    paintDay(); buildChips(); updatePreview();
    setTimeout(()=>{ if(!els.evTitle.value) els.evTitle.focus(); }, 100);
  }
  const closeSheetFn=()=> els.sheet.classList.remove('open');
  els.closeSheet.addEventListener('click', closeSheetFn);

  function buildChips(){
    const now=new Date();
    const chips=[
      {label:'+30m', act:()=> setFrom(30)},
      {label:'+1h', act:()=> setFrom(60)},
      {label:'Hoy 18:00', act:()=> setDate(strip(new Date()), '18:00')},
      {label:'Ma√±ana 9:00', act:()=> {const d=new Date(); d.setDate(d.getDate()+1); setDate(strip(d),'09:00');}},
      {label:'Pr√≥x. Lunes 9:00', act:()=> setDate(nextDow(new Date(),1),'09:00')},
    ];
    const box=els.quickChips; box.innerHTML='';
    chips.forEach(c=>{
      const b=document.createElement('button'); b.className='chip-btn'; b.textContent=c.label;
      b.addEventListener('click', ()=>{ c.act(); updatePreview(); });
      box.appendChild(b);
    });
    function setFrom(min){ const when=new Date(now.getTime()+min*60000); setDate(strip(when), when.toTimeString().slice(0,5)); els.evOffset.value='0'; }
    function setDate(d, hhmm){ state.selected=d; els.sheetDate.textContent=fmtLong(d); els.evTime.value=hhmm; }
  }

  function paintDay(){
    if (!els.sheet.classList.contains('open')) return;
    const data=load(), key=ymd(state.selected), items=data[key]||[];
    els.evList.innerHTML = items.length ? '' : `<div class="subtitle" style="margin:10px 14px;">Sin recordatorios todav√≠a.</div>`;
    items.map((it,idx)=>({it,idx,u:urg(it.remindAt,it.done)}))
      .sort((a,b)=>({high:0,med:1,low:2,past:3}[a.u]-({high:0,med:1,low:2,past:3}[b.u])))
      .forEach(({it,idx,u})=>{
        const row=document.createElement('div'); row.className='ev'; if (it.done) row.classList.add('done'); row.dataset.urg=u;
        const when=new Date(it.remindAt), diff=when.getTime()-Date.now(), r=rel(diff);
        const off=it.offsetMin ? ` ¬∑ ${it.offsetMin}m antes` : '';
        row.innerHTML=`
          <div class="time">${it.time||'--:--'}</div>
          <div class="title">${esc(it.title||'Sin t√≠tulo')}</div>
          <div class="meta">${r}${off}</div>
          <div style="margin-left:8px; display:flex; gap:6px">
            <button class="mini good" data-done="${idx}" title="Hecho">‚úî</button>
            <button class="mini" data-snooze="${idx}" title="Posponer 10 min">‚è∞+10m</button>
            <button class="mini danger" data-del="${idx}" title="Eliminar">üóë</button>
          </div>`;
        row.querySelector('[data-del]').addEventListener('click', e=>{
          const i=+e.currentTarget.getAttribute('data-del'); const map=load(); map[key].splice(i,1); save(map); paintDay(); render();
        });
        row.querySelector('[data-done]').addEventListener('click', e=>{
          const i=+e.currentTarget.getAttribute('data-done'); const map=load(); map[key][i].done=!map[key][i].done; save(map); paintDay(); render(); toast('¬°Listo! ‚úî');
        });
        row.querySelector('[data-snooze]').addEventListener('click', e=>{
          const i=+e.currentTarget.getAttribute('data-snooze'); const map=load(); const now=Date.now();
          map[key][i].remindAt = now + 10*60000;
          const d=new Date(map[key][i].remindAt); map[key][i].date=ymd(d); map[key][i].time=d.toTimeString().slice(0,5);
          save(map);
          if (map[key][i].date!==key){
            const moved=map[key].splice(i,1)[0];
            map[moved.date]=map[moved.date]||[]; map[moved.date].push(moved); save(map);
          }
          paintDay(); render(); toast('Pospuesto 10 min ‚è∞');
        });
        els.evList.appendChild(row);
      });
  }

  // Preview
  function updatePreview(){
    const p = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    const eventAt = toDT(p.date, p.hhmm);
    const remindAt = new Date(eventAt.getTime() - p.offsetMin*60000);
    const whenTxt = new Intl.DateTimeFormat('es-MX',{weekday:'short', day:'numeric', month:'short'}).format(p.date);
    const offsetTxt = p.offsetMin ? ` ¬∑ üîî ${p.offsetMin}m antes` : '';
    els.previewText.textContent = `üìå ${p.title || '‚Äî'}  ¬∑  ‚è±Ô∏è ${whenTxt} ${p.hhmm}${offsetTxt}`;
  }
  ['keyup','change','input'].forEach(ev=>{
    els.evTitle.addEventListener(ev, updatePreview);
    els.evTime.addEventListener(ev, updatePreview);
    els.evOffset.addEventListener(ev, updatePreview);
  });

  // Guardar
  els.saveBtn.addEventListener('click', ()=>{
    const p = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    if (!p.title){ els.evTitle.focus(); return; }
    state.selected = p.date;
    const eventAt = toDT(p.date, p.hhmm);
    const remindAt = new Date(eventAt.getTime() - p.offsetMin*60000);
    const map=load(); const key=ymd(p.date);
    map[key]=map[key]||[];
    map[key].push({ title: p.title, date:key, time:p.hhmm, offsetMin:p.offsetMin, eventAt:eventAt.getTime(), remindAt:remindAt.getTime(), createdAt:Date.now(), done:false });
    save(map);
    els.evTitle.value=''; els.evTime.value=p.hhmm; els.evOffset.value=String(p.offsetMin);
    els.sheetDate.textContent=fmtLong(p.date); updatePreview(); paintDay(); render();
    toast('Recordatorio guardado');
  });

  // FAB & nav
  els.fab.addEventListener('click', ()=>{ if (!els.sheet.classList.contains('open')) openSheet(); els.evTitle.focus(); });
  els.prevBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()-1, 1); render(); });
  els.nextBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()+1, 1); render(); });
  els.todayBtn.addEventListener('click', ()=>{ const t=strip(new Date()); state.view=new Date(t.getFullYear(), t.getMonth(), 1); state.selected=t; render(); openSheet(); });

  // Gestos
  els.grid.addEventListener('touchstart', e=>{ state.touch={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()}; }, {passive:true});
  els.grid.addEventListener('touchend', e=>{
    if (!state.touch) return; const dx=e.changedTouches[0].clientX-state.touch.x, dy=e.changedTouches[0].clientY-state.touch.y, dt=Date.now()-state.touch.t;
    if (Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy) && dt<450){ (dx<0)?els.nextBtn.click():els.prevBtn.click(); }
    state.touch=null;
  });

  // Drag para cerrar
  let dragY=null;
  els.dragbar.addEventListener('touchstart', e=>{ dragY=e.touches[0].clientY; }, {passive:true});
  els.dragbar.addEventListener('touchend', e=>{ if(dragY==null) return; const dy=e.changedTouches[0].clientY-dragY; if (dy>40) els.closeSheet.click(); dragY=null; });

  // init
  (function start(){
    renderWeekdays(); render(); updatePreview();
    setInterval(()=>{ render(); if (els.sheet.classList.contains('open')) { paintDay(); updatePreview(); } }, 60*1000);
  })();
}
</script>
</body>
</html>
