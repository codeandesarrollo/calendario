<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Calendario · Recordatorios</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<meta name="theme-color" content="#0e1118" />

<style>
  :root{
    --bg:#07090e; --panel:#0e1118; --card:#111522; --glass:rgba(20,23,35,.55);
    --text:#f4f7ff; --muted:#a9b3c5; --border:rgba(255,255,255,.08);
    --accent-a:#30e0a1; --accent-b:#7b7bff; --accent-c:#ff77e1; --ring:rgba(123,123,255,.55);
    --shadow:0 18px 45px rgba(0,0,0,.45); --radius:22px;
    --u-high:#ff6161; --u-med:#ffd157; --u-low:#63f3a7; --u-past:#93a0b5;
    --touch:48px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:"Sora",system-ui,-apple-system,Segoe UI,Roboto,"Inter",sans-serif;
    background: radial-gradient(1000px 600px at 50% -260px, #151827 20%, var(--bg) 60%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }
  /* blobs decorativos */
  .bg-blobs::before,.bg-blobs::after{
    content:""; position:fixed; inset:auto; z-index:-1; filter:blur(70px); opacity:.45; pointer-events:none;
    width:380px; height:380px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #1de9b6, transparent 60%);
    animation: float1 16s ease-in-out infinite;
  }
  .bg-blobs::after{
    width:420px; height:420px; right:-120px; bottom:-140px; opacity:.35;
    background: radial-gradient(circle at 70% 40%, #7c8cff, transparent 60%);
    animation: float2 22s ease-in-out infinite;
  }
  @keyframes float1{0%,100%{transform:translate(-80px,-60px)}50%{transform:translate(20px,10px)}}
  @keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(-40px,40px)}}

  .app{min-height:100dvh; padding-bottom:calc(env(safe-area-inset-bottom) + 84px); max-width:520px; margin:0 auto; display:flex; flex-direction:column;}
  /* topbar */
  .topbar{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(7,9,14,.9), rgba(7,9,14,.55)); backdrop-filter: blur(14px); border-bottom:1px solid var(--border)}
  .topbar-inner{display:flex; align-items:center; gap:10px; padding: calc(env(safe-area-inset-top) + 16px) 16px 12px;}
  .round{width:var(--touch); height:var(--touch); display:grid; place-items:center; border-radius:14px; border:1px solid var(--border); background:#0b0f18; color:var(--text); cursor:pointer; transition:.08s transform}
  .round:active{ transform:scale(.98) }
  .title{flex:1; text-align:center; display:flex; align-items:center; justify-content:center; gap:10px; font-weight:700; letter-spacing:.3px;}
  .title .month-year{ font-size:1.2rem; background: linear-gradient(90deg,var(--accent-a),var(--accent-b),var(--accent-c)); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .chip{border:1px solid var(--border); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:.82rem; background:#0b0f18; cursor:pointer}
  .streak{font-size:.78rem; color:var(--muted)}

  /* ===== CALENDARIO MEJORADO ===== */
  .card{
    margin:16px; padding:12px; border-radius:26px;
    background: linear-gradient(var(--card), var(--card)) padding-box,
               linear-gradient(135deg, rgba(48,224,161,.35), rgba(123,123,255,.28), rgba(255,119,225,.28)) border-box;
    border:1px solid transparent; box-shadow: var(--shadow);
  }
  .weekdays{display:grid; grid-template-columns:repeat(7,1fr); padding:6px 10px 8px; gap:6px; font-size:.82rem; color:#c6ceea; text-align:center; letter-spacing:.3px}
  .weekdays div:nth-child(6), .weekdays div:nth-child(7){ color:#9fbaff }

  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:10px; padding:8px 10px 12px;}
  .day{
    position:relative; aspect-ratio:1/1; border-radius:18px;
    display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:1.02rem; letter-spacing:.2px;
    color:#e7ecff;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
    border:1px solid var(--border); cursor:pointer; touch-action:manipulation;
    transition: transform .08s ease, box-shadow .20s ease, border-color .2s ease, background .2s ease, color .2s ease;
  }
  .day:hover{ transform: translateY(-1px); }
  .day.out{ color:#8c94a7; opacity:.9; }
  .day.weekend{ color:#dfe6ff; background:linear-gradient(180deg, rgba(124,140,255,.06), rgba(255,255,255,.02)); }
  .ring-today{position:absolute; inset:6px; border-radius:14px; border:2px solid var(--ring); pointer-events:none; box-shadow: 0 0 0 6px rgba(123,123,255,.10);}
  .day.selected{ color:#10131b; background: radial-gradient(240px 160px at 50% -30%, rgba(48,224,161,.38), transparent 60%), radial-gradient(220px 140px at 20% 120%, rgba(123,123,255,.38), transparent 55%), #e9f0ff; border-color: rgba(123,123,255,.45); box-shadow: 0 8px 28px rgba(0,0,0,.30), inset 0 0 0 2px rgba(123,123,255,.20); }
  /* halo por urgencia del día */
  .day[data-maxurg="high"]{ box-shadow: inset 0 0 0 2px rgba(255,97,97,.35), 0 10px 26px rgba(255,97,97,.12); }
  .day[data-maxurg="med"] { box-shadow: inset 0 0 0 2px rgba(255,209,87,.30), 0 10px 26px rgba(255,209,87,.10); }
  .day[data-maxurg="low"] { box-shadow: inset 0 0 0 2px rgba(99,243,167,.28), 0 10px 26px rgba(99,243,167,.08); }
  .day[data-maxurg="past"]{ box-shadow: inset 0 0 0 2px rgba(147,160,181,.26); }
  .badges{ position:absolute; left:8px; bottom:8px; display:flex; gap:5px }
  .dot{ width:7px; height:7px; border-radius:999px; }
  .dot.high{ background:var(--u-high); box-shadow:0 0 0 3px rgba(255,101,101,.16); }
  .dot.med { background:var(--u-med);  box-shadow:0 0 0 3px rgba(255,211,100,.16); }
  .dot.low { background:var(--u-low);  box-shadow:0 0 0 3px rgba(102,245,160,.16); }
  .dot.past{ background:var(--u-past); box-shadow:0 0 0 3px rgba(147,160,181,.16); }

  /* ===== SHEET SIMPLE PARA AGREGAR ===== */
  .sheet{ position:fixed; left:0; right:0; bottom:0; transform:translateY(100%); transition:transform .28s ease; z-index:50; padding-bottom: env(safe-area-inset-bottom); }
  .sheet.open{ transform:translateY(0) }
  .panel{
    background: linear-gradient(180deg, rgba(18,22,33,.92), rgba(10,12,18,.96));
    backdrop-filter: blur(12px);
    border-top-left-radius: 26px; border-top-right-radius: 26px;
    border:1px solid var(--border); box-shadow: var(--shadow);
    padding:12px 12px 18px; max-width:520px; margin:0 auto;
  }
  .dragbar{ width:52px; height:6px; background:#2e3342; border-radius:999px; margin:6px auto 12px; }
  .panel h3{ margin:6px 0 0; font-size:1.02rem; }
  .subtitle{ color:var(--muted); font-size:.86rem; }

  /* barra rápida */
  .quick{
    display:grid; grid-template-columns:1fr auto auto; gap:8px; margin:12px 0 6px;
    align-items:center;
  }
  .input{
    height:46px; background:#0e1118; border:1px solid var(--border); color:var(--text);
    border-radius:14px; padding:10px 12px; font:inherit; outline:none; width:100%;
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  .input:focus{ border-color: rgba(124,140,255,.45); box-shadow: 0 0 0 4px rgba(124,140,255,.12); }
  .control{ display:flex; align-items:center; gap:8px; height:46px; padding:0 10px; border-radius:14px; border:1px solid var(--border); background:#0f1118; color:#dbe4ff; }
  .control select, .control input[type="time"]{ background:none; border:0; color:inherit; font:inherit; outline:none; }
  .control small{ color:var(--muted) }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px}
  .chip-btn{ background:#0f1118; border:1px solid var(--border); color:#bcd0ff; border-radius:999px; padding:8px 10px; font-size:.78rem; cursor:pointer; }
  .chip-btn:hover{ color:#fff }

  .preview{ font-size:.86rem; color:#c9d7ff; background:#0f131d; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }

  .btn{
    height:48px; padding:0 16px; border-radius:14px; font-weight:800; cursor:pointer; border:0;
    background: linear-gradient(90deg, #27d8b7, #8ea0ff); color:#031a15; box-shadow: 0 14px 28px rgba(19,190,160,.30);
  }
  .btn.secondary{ background:#161a24; color:var(--muted); border:1px solid var(--border); box-shadow:none }

  /* lista de eventos */
  .ev-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
  .ev{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius:16px; padding:12px;
    display:flex; gap:10px; align-items:center;
  }
  .ev .time{ font-weight:700; font-size:.92rem; color:#cdd6ff; min-width:62px }
  .ev .title{ font-size:.98rem }
  .ev .meta{ margin-left:auto; font-size:.78rem; color:#muted; }
  .ev.done .title{ text-decoration: line-through; opacity:.7; }
  .ev[data-urg="high"]{ border-left:5px solid var(--u-high); background:linear-gradient(180deg, rgba(255,101,101,.08), transparent); }
  .ev[data-urg="med"] { border-left:5px solid var(--u-med);  background:linear-gradient(180deg, rgba(255,211,100,.08), transparent); }
  .ev[data-urg="low"] { border-left:5px solid var(--u-low);  background:linear-gradient(180deg, rgba(102,245,160,.08), transparent); }
  .ev[data-urg="past"]{ border-left:5px solid var(--u-past); background:linear-gradient(180deg, rgba(147,160,181,.08), transparent); }

  .mini{ height:36px; padding:0 10px; border-radius:10px; border:1px solid var(--border); background:#10131b; color:#fff; cursor:pointer; }
  .mini.danger{ border-color: rgba(255,101,101,.4); }
  .mini.good{ border-color: rgba(102,245,160,.4); color:#66f5a0; }
  .mini.tg{ border-color: rgba(126,206,255,.45); color:#8ecbff; }

  .fab{
    position:fixed; right:16px; bottom: calc(env(safe-area-inset-bottom) + 16px);
    display:flex; align-items:center; gap:10px;
    height:56px; padding:0 16px 0 14px; border-radius:18px;
    background:linear-gradient(90deg, #2be7c2, #8ea0ff);
    color:#041a16; font-weight:800; letter-spacing:.2px;
    box-shadow: 0 16px 36px rgba(46, 214, 186, .35);
    cursor:pointer; z-index:40;
  }

  .toast{ position:fixed; left:50%; bottom: calc(env(safe-area-inset-bottom) + 84px); transform: translateX(-50%) translateY(20px); background: #10141d; color:#d8e0ff; border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); opacity:0; transition: .25s ease; z-index:60; }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
  .errorbar{ position:fixed; left:16px; right:16px; top:16px; z-index:100; background:#3a1010; border:1px solid #ff6b6b; color:#ffdcdc; padding:10px 12px; border-radius:12px; }

  /* ========== MASCOTA (mismo módulo con drag + poses) ========== */
  .pet{position:fixed; left:16px; bottom:16px; display:flex; align-items:flex-end; gap:10px; z-index:60; user-select:none; cursor:grab;}
  .pet.dragging{cursor:grabbing}
  .pet.idle .pet-svg{ animation:petFloat 6s ease-in-out infinite; }
  @keyframes petFloat{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
  .pet-svg{ width:120px; height:120px; filter:drop-shadow(0 16px 30px rgba(0,0,0,.35)); transition:transform .15s ease; }
  .eye{ transform-origin:center; animation:blink 4.5s infinite; }
  @keyframes blink{ 0%,2%,60%,62%,100%{transform:scaleY(1)} 1%,61%{transform:scaleY(.1)} }
  .arm-right{ transform-origin:88px 66px; }
  .tail{ transform-origin:102px 84px; }
  .pet.wave .arm-right{ animation:waveArm 1.2s ease }
  @keyframes waveArm{ 0%{transform:rotate(0)} 30%{transform:rotate(-22deg)} 60%{transform:rotate(14deg)} 100%{transform:rotate(0)} }
  .pet.wag  .tail{ animation:wagTail 1.2s ease }
  @keyframes wagTail{ 0%{transform:rotate(0)} 30%{transform:rotate(18deg)} 60%{transform:rotate(-12deg)} 100%{transform:rotate(0)} }
  .pose-alert .pet-svg{ animation:alertShake .6s ease-in-out infinite !important; }
  @keyframes alertShake{ 0%{transform:translate(0) rotate(0)} 25%{transform:translate(1px,-1px) rotate(-2deg)} 50%{transform:translate(-1px,1px) rotate(2deg)} 75%{transform:translate(1px,0) rotate(-1.5deg)} 100%{transform:translate(0) rotate(0)} }
  .pose-focus .pet-svg{ animation:focusBreath 2s ease-in-out infinite !important; }
  @keyframes focusBreath{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.03)} }
  .pose-happy .pet-svg{ animation:happyHop 1.2s ease-in-out infinite !important; }
  @keyframes happyHop{ 0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)} }

  /* Globo del mensaje */
  .pet-bubble{
    max-width:70vw; background:rgba(16,20,29,.9);
    border:1px solid rgba(255,255,255,.08); padding:10px 12px; padding-right:46px;
    border-radius:12px; box-shadow:0 14px 30px rgba(0,0,0,.35);
    transform:translateY(8px); opacity:0; transition:.25s ease; position:relative;
  }
  .pet-bubble::after{content:""; position:absolute; left:14px; bottom:-7px; width:12px; height:12px; background:rgba(16,20,29,.9); border-left:1px solid rgba(255,255,255,.08); border-bottom:1px solid rgba(255,255,255,.08); transform:rotate(45deg);}
  .pet-bubble.show{opacity:1; transform:translateY(0);}
  .pet-bubble .txt{font-size:.9rem; color:#dbe3ff}
  .pet-bubble .x{position:absolute; top:4px; right:6px; width:22px; height:22px; border-radius:6px; background:#131722; color:#9aa3b2; border:1px solid rgba(255,255,255,.08); cursor:pointer}

  /* Engranaje fuera del globo */
  .pet-gear{
    position:absolute;
    left:88px;
    bottom:112px;
    width:34px; height:34px;
    border-radius:10px;
    background:#10141d;
    color:#cfd6ff;
    border:1px solid rgba(255,255,255,.10);
    display:grid; place-items:center;
    box-shadow:0 12px 24px rgba(0,0,0,.35);
    cursor:pointer;
    z-index:61;
  }
  .pet-gear:active{ transform:scale(.96); }

  .pet-show{position:fixed; left:16px; bottom:16px; background:#10141d; color:#dbe3ff; border:1px solid rgba(255,255,255,.08); height:38px; padding:0 12px; border-radius:999px; display:none; align-items:center; gap:6px; z-index:60}
  .pet-show::before{content:"Mascota"; font-size:.82rem; color:#9aa3b2}
  .fx{position:absolute; inset:0; overflow:visible; pointer-events:none;}
  .confetti{position:absolute; bottom:14px; font-size:16px; animation:confettiUp 1.6s ease forwards; opacity:.95}
  @keyframes confettiUp{ 0%{transform:translateY(0) scale(.9);opacity:.95} 70%{transform:translateY(-40px) scale(1);opacity:1} 100%{transform:translateY(-60px) scale(.95);opacity:0} }
  /* paletas por especie */
  .pet{ --p-body:#8ea0ff; --p-belly:#b9c3ff; --p-cheek:#ffbfd1; --p-eye:#0e1118; --p-nose:#20242e; --p-beak:#f6a53e; }
  .pet[data-species="cat"]{ --p-body:#8ea0ff; --p-belly:#b9c3ff; --p-nose:#1e2430; }
  .pet[data-species="dog"]{ --p-body:#d28a4a; --p-belly:#f2b572; --p-nose:#1a1a1a; }
  .pet[data-species="chick"]{ --p-body:#ffe56d; --p-belly:#fff49d; --p-eye:#272727; --p-beak:#f6a53e; }
  .pet[data-species="koala"]{ --p-body:#aeb9c8; --p-belly:#cfd6df; --p-nose:#2f2f3a; }
  .pet[data-species="chick"] .ears{display:none} .pet[data-species="chick"] .tail{display:none} .pet[data-species="chick"] .nose{display:none} .pet[data-species="chick"] .beak{display:block}
  .pet[data-species="cat"] .beak, .pet[data-species="dog"] .beak, .pet[data-species="koala"] .beak{display:none}
  .pet-picker{position:fixed; inset:0; display:none; place-items:end center; z-index:70; background:rgba(0,0,0,.25); backdrop-filter: blur(2px);}
  .pet-picker.open{display:grid}
  .pet-panel{width:100%; max-width:520px; background:linear-gradient(180deg, rgba(20,23,35,.95), rgba(12,14,20,.95)); border-top-left-radius:24px; border-top-right-radius:24px; border:1px solid rgba(255,255,255,.08); padding:14px 16px 18px;}
  .pet-panel h4{margin:6px 0 10px; font-size:1rem}
  .pet-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  .pet-opt{border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; background:#0f1118; text-align:center; cursor:pointer}
  .pet-opt .avatar{width:54px; height:54px; border-radius:12px; display:grid; place-items:center; margin:0 auto 6px; font-size:28px}
  .pet-opt small{color:#9aa3b2; font-size:.76rem}
  .pet-opt.active{outline:2px solid #7c8cff}

  @media (min-width:521px){ body{ display:grid; place-items:center; } }
</style>
</head>
<body class="bg-blobs">
  <div class="app">
    <div class="topbar">
      <div class="topbar-inner">
        <button class="round" id="prevBtn" aria-label="Mes anterior">‹</button>
        <div class="title">
          <span class="month-year" id="monthLabel">—</span>
          <button class="chip" id="todayBtn" aria-label="Ir a hoy">Hoy</button>
          <button class="chip" id="installBtn" style="display:none">Instalar</button>

          <span class="streak" id="streakLabel">🔥 0</span>
        </div>
        <button class="round" id="nextBtn" aria-label="Mes siguiente">›</button>
      </div>
    </div>

    <div class="card">
      <div class="weekdays" id="weekdays"></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <button class="fab" id="fab" title="Nuevo recordatorio"><span class="plus">＋</span> Nuevo</button>

  <!-- Sheet simplificado -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div class="dragbar" id="dragbar"></div>
      <h3 id="sheetDate">—</h3>
      <div class="subtitle">Recordatorios de este día</div>

      <!-- barra rápida -->
      <div class="quick">
        <input class="input" id="evTitle" type="text" placeholder="📝 Ej: 'Dentista 14:30 10 min antes' o 'en 2h comprar pan'">
        <div class="control" title="Hora"><small>🕒</small><input id="evTime" type="time" value="09:00"></div>
        <div class="control" title="Aviso"><small>🔔</small>
          <select id="evOffset">
            <option value="0">a la hora</option><option value="5">5m</option><option value="10">10m</option>
            <option value="15">15m</option><option value="30">30m</option><option value="60">1h</option>
            <option value="120">2h</option><option value="1440">1d</option>
          </select>
        </div>
      </div>

      <div class="chips" id="quickChips"></div>
      <div class="preview" id="previewText">—</div>

      <div class="ev-list" id="evList"></div>

      <div style="display:flex; gap:10px; margin-top:12px">
        <button class="btn" id="saveBtn" style="flex:1">Guardar</button>
        <!-- NUEVO: Guardar + Telegram -->
        <button class="btn" id="saveTgBtn" style="flex:1; background:linear-gradient(90deg, #2aa6ff, #7b7bff); color:#02131c">Guardar + TG</button>
        <button class="btn secondary" id="closeSheet">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Mascota -->
  <div id="pet" class="pet idle" data-species="cat" aria-live="polite">
    <svg class="pet-svg" viewBox="0 0 120 120" aria-hidden="true">
      <rect class="tail" x="96" y="76" rx="10" ry="10" width="10" height="22" fill="var(--p-body)"/>
      <ellipse cx="60" cy="82" rx="34" ry="26" fill="var(--p-body)"/>
      <ellipse cx="60" cy="86" rx="22" ry="16" fill="var(--p-belly)"/>
      <rect x="30" y="66" width="14" height="18" rx="8" fill="var(--p-body)" />
      <rect class="arm-right" x="74" y="58" width="14" height="26" rx="8" fill="var(--p-body)" />
      <circle cx="60" cy="46" r="26" fill="var(--p-body)"/>
      <g class="ears" fill="var(--p-body)">
        <path d="M36 34 l-10 -8 a10 10 0 0 1 18 -6 z"/>
        <path d="M84 34 l10 -8 a10 10 0 0 0 -18 -6 z"/>
      </g>
      <g fill="var(--p-eye)">
        <circle class="eye" cx="50" cy="45" r="3.2"/>
        <circle class="eye" cx="70" cy="45" r="3.2"/>
      </g>
      <g class="nose" fill="var(--p-nose)"><ellipse cx="60" cy="52" rx="4.5" ry="3.2"/></g>
      <g class="beak"><polygon points="60,50 66,54 60,58 54,54" fill="var(--p-beak)"/></g>
      <g fill="#ffbfd1" opacity=".45"><circle cx="44" cy="52" r="4"/><circle cx="76" cy="52" r="4"/></g>
      <rect x="46" y="98" width="14" height="10" rx="6" fill="var(--p-body)"/>
      <rect x="60" y="98" width="14" height="10" rx="6" fill="var(--p-body)"/>
    </svg>

    <!-- Engranaje fuera del globo -->
    <button id="petGear" class="pet-gear" title="Cambiar mascota">⚙️</button>

    <div id="petFx" class="fx"></div>

    <!-- Globo -->
    <div id="petBubble" class="pet-bubble" role="status">
      <button id="petHide" class="x" title="Ocultar">×</button>
      <span class="txt">Hola 👋</span>
    </div>
  </div>
  <button id="petShow" class="pet-show">🐾</button>

  <!-- Selector -->
  <div id="petPicker" class="pet-picker" aria-modal="true" role="dialog">
    <div class="pet-panel">
      <h4>Elige tu mascota</h4>
      <div class="pet-grid">
        <button class="pet-opt" data-species="dog"><div class="avatar">🐶</div><small>Cachorrito</small></button>
        <button class="pet-opt" data-species="cat"><div class="avatar">🐱</div><small>Gatito</small></button>
        <button class="pet-opt" data-species="chick"><div class="avatar">🐥</div><small>Pollito</small></button>
        <button class="pet-opt" data-species="koala"><div class="avatar">🐨</div><small>Koala</small></button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => { try{ initCalendar(); }catch(e){ fatal(e); } });

function fatal(err){
  console.error(err);
  const bar=document.createElement('div');
  bar.className='errorbar';
  bar.innerHTML=`<strong>⚠️ Error en el calendario:</strong> ${err.message||err}`;
  document.body.appendChild(bar);
}
function toast(msg){
  const t=document.createElement('div');
  t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),250); }, 1500);
}

/* ===== Utilidades Telegram ===== */
function tgShareLinkFromEvent(title, eventAtMs, offsetMin){
  const when = new Date(eventAtMs||Date.now());
  const fmt = new Intl.DateTimeFormat('es-MX', { dateStyle:'full', timeStyle:'short' }).format(when);
  const offTxt = offsetMin ? ` (🔔 ${offsetMin}m antes)` : '';
  const text = `📌 ${title}\n🗓️ ${fmt}${offTxt}\n\n#Recordatorio`;
  const base = 'https://t.me/share/url';
  const urlParam = encodeURIComponent(location.href);
  return `${base}?url=${urlParam}&text=${encodeURIComponent(text)}`;
}

/* ===== Mascota con drag + poses ===== */
const Pet = (()=>{

  let root,bubble,showBtn,hideBtn,gearBtn,picker,opts,holdTimer=null;
  const LS_HIDE='pet_hidden_v1', LS_SPEC='pet_species_v1', LS_POS='pet_pos_v1';

  // temporizador para cancelar tipeo previo
  let typingTimer = null;

  function create(){
    root=document.getElementById('pet'); bubble=document.getElementById('petBubble');
    showBtn=document.getElementById('petShow'); hideBtn=document.getElementById('petHide');
    gearBtn=document.getElementById('petGear'); picker=document.getElementById('petPicker');
    opts=[...picker.querySelectorAll('.pet-opt')];
    const hidden = localStorage.getItem(LS_HIDE)==='1';
    const species = localStorage.getItem(LS_SPEC) || root.dataset.species || 'cat';
    setSpecies(species); applySavedPos();
    root.style.display = hidden ? 'none':'flex'; showBtn.style.display = hidden ? 'inline-flex':'none';

    hideBtn.addEventListener('click', hidePet);
    showBtn.addEventListener('click', ()=>{ show(); wave(); say(greetMsg()); });
    gearBtn.addEventListener('click', openPicker);
    opts.forEach(b=> b.addEventListener('click', ()=>{ setSpecies(b.dataset.species); closePicker(); wave(); say(specyHello()); }));
    picker.addEventListener('click', (e)=>{ if (e.target===picker) closePicker(); });
    root.addEventListener('touchstart', ()=>{ holdTimer=setTimeout(openPicker, 550); }, {passive:true});
    root.addEventListener('touchend', ()=>{ clearTimeout(holdTimer); holdTimer=null; });
    enableDrag(); setMood((new Date()).getHours()); setPose('idle');
    return api;
  }

  function enableDrag(){
    let drag=false, sx=0, sy=0, startL=0, startB=0; const getNum=v=>Number(String(v||'0').replace('px',''))||0;
    const clamp=(v,min,max)=> Math.max(min, Math.min(max, v));
    const el=document.getElementById('pet');
    el.addEventListener('pointerdown', e=>{
      // No arrastrar si se hace click en el globo o en el engranaje
      if (e.target.closest('.pet-bubble') || e.target.closest('#petGear')) return;
      drag=true; el.classList.add('dragging'); el.setPointerCapture(e.pointerId);
      sx=e.clientX; sy=e.clientY; const cs=getComputedStyle(el); startL=getNum(cs.left); startB=getNum(cs.bottom);
    });
    el.addEventListener('pointermove', e=>{ if(!drag)return; const dx=e.clientX-sx, dy=e.clientY-sy; const rect=el.getBoundingClientRect(); const nl=clamp(startL+dx,8,innerWidth-rect.width-8); const nb=clamp(startB-dy,8,innerHeight-rect.height-8); el.style.left=nl+'px'; el.style.bottom=nb+'px'; });
    el.addEventListener('pointerup', ()=>{ if(!drag)return; drag=false; el.classList.remove('dragging'); localStorage.setItem(LS_POS, JSON.stringify({left:parseInt(el.style.left||'16'), bottom:parseInt(el.style.bottom||'16')})); });
  }
  function applySavedPos(){ try{ const p=JSON.parse(localStorage.getItem(LS_POS)||'{}'); if(typeof p.left==='number') pet.style.left=p.left+'px'; if(typeof p.bottom==='number') pet.style.bottom=p.bottom+'px'; }catch{} }
  function setSpecies(sp){ pet.dataset.species=sp; localStorage.setItem(LS_SPEC,sp); if (opts) opts.forEach(o=> o.classList.toggle('active', o.dataset.species===sp)); }
  function openPicker(){ picker.classList.add('open'); } function closePicker(){ picker.classList.remove('open'); }

  function show(){ pet.style.display='flex'; showBtn.style.display='none'; localStorage.setItem(LS_HIDE,'0'); }
  function hidePet(){
    // al ocultar, apagar cualquier tipeo en progreso
    if (typingTimer){ clearInterval(typingTimer); typingTimer=null; }
    bubble.classList.remove('show');
    pet.style.display='none'; showBtn.style.display='inline-flex'; localStorage.setItem(LS_HIDE,'1');
  }

  function wave(){ pet.classList.add('wave','wag'); setTimeout(()=> pet.classList.remove('wave','wag'),1200); }
  function sleep(){ pet.classList.add('sleep'); } function wake(){ pet.classList.remove('sleep'); }
  function setMood(h){ (h>=22||h<6)?sleep():wake(); }
  function setPose(p){ pet.classList.remove('pose-alert','pose-focus','pose-happy'); if(p==='alert')pet.classList.add('pose-alert'); else if(p==='focus')pet.classList.add('pose-focus'); else if(p==='happy')pet.classList.add('pose-happy'); }

  // decir mensaje sin mezclar letras (cancela y escribe por codepoints)
  function say(text){
    bubble.classList.add('show');

    if (typingTimer){ clearInterval(typingTimer); typingTimer = null; }

    const t = bubble.querySelector('.txt');
    t.textContent = '';

    const glyphs = Array.from(text); // emojis y acentos seguros
    let i = 0;

    typingTimer = setInterval(()=>{
      t.textContent += glyphs[i++];
      if (i >= glyphs.length){
        clearInterval(typingTimer);
        typingTimer = null;
      }
    }, 18);
  }

  function specyHello(){ const sp=pet.dataset.species; return sp==='dog'?'¡Guau! 🐶':sp==='cat'?'¡Miau! 🐱':sp==='chick'?'¡Pío! 🐥':'¡Hola! 🐨'; }
  function greetMsg(){ const h=(new Date()).getHours(); const base=h<12?'¡Buenos días!':(h<19?'¡Buenas tardes!':'¡Buenas noches!'); return `${base} ${specyHello()}`; }
  function greet(ctx){ setMood((new Date()).getHours()); wave(); if(ctx&&ctx.todayTotal>0){ const t=ctx.todayPending>0?`${greetMsg()} Hoy tienes ${ctx.todayPending} pendiente(s).`:`${greetMsg()} ¡Todo listo por hoy! ✨`; say(t);} else { say(`${greetMsg()} ¿Agendamos algo?`);} }
  function confetti(){ const fx=document.getElementById('petFx'); for(let i=0;i<10;i++){ const s=document.createElement('span'); s.className='confetti'; s.style.left=(10+Math.random()*100)+'px'; s.style.animationDelay=(Math.random()*0.2)+'s'; s.textContent=['✨','🎉','🌟','💖'][Math.floor(Math.random()*4)]; fx.appendChild(s); setTimeout(()=>s.remove(),1800);} }
  const api={create,setSpecies,openPicker,closePicker,greet,say: say,wave,confetti,setPose};
  return api;
})();

/* ===== Calendario ===== */
function initCalendar(){
  const ids=['monthLabel','weekdays','grid','prevBtn','nextBtn','todayBtn','sheet','sheetDate','evList','evTitle','evTime','evOffset','saveBtn','saveTgBtn','closeSheet','fab','dragbar','streakLabel','quickChips','previewText'];
  const $=id=>document.getElementById(id);
  const els=Object.fromEntries(ids.map(id=>[id,$(id)]));
  if (Object.values(els).some(v=>!v)) throw new Error('Faltan elementos del DOM');

  const pet = Pet.create(); window.__pet=pet; let greeted=false, lastPose='idle';

  const WEEK_START='monday', locale='es-MX';
  const URG={high:'high',med:'med',low:'low',past:'past'};
  const thresholds={ highMs:60*60*1000, medMs:24*60*60*1000 };
  const state={ view:stripTime(new Date()), selected:stripTime(new Date()), touch:null, storeKey:'cal_events_v3_smart' };

  // fechas & helpers
  function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function ymd(d){ return d.toISOString().slice(0,10); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function weekdayIndex(date){ const iso=date.getDay(); return WEEK_START==='monday' ? (iso+6)%7 : iso; }
  function formatMonthYear(d){ const m=new Intl.DateTimeFormat(locale,{month:'long'}).format(d); return (m[0].toUpperCase()+m.slice(1))+' '+d.getFullYear(); }
  function formatLong(d){ const s=new Intl.DateTimeFormat(locale,{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(d); return s[0].toUpperCase()+s.slice(1); }
  function toDateTime(baseDate, hhmm){ const [h,m]=(hhmm||'00:00').split(':').map(Number); return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h||0, m||0, 0, 0); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function relTime(ms){ const s=Math.round(ms/1000), past=s<0, abs=Math.abs(s), min=60, hr=3600, day=86400; let n,u; if(abs<min){n=abs;u='seg';} else if(abs<hr){n=Math.round(abs/min);u='min';} else if(abs<day){n=Math.round(abs/hr);u='h';} else {n=Math.round(abs/day);u='d';} return past?`hace ${n} ${u}`:`en ${n} ${u}`; }
  function urgencyFor(remindAtMs, done){ if (done) return URG.past; const diff=remindAtMs - Date.now(); if (diff<0) return URG.past; if (diff<=thresholds.highMs) return URG.high; if (diff<=thresholds.medMs) return URG.med; return URG.low; }

  // storage
  function loadEvents(){ try{ return JSON.parse(localStorage.getItem(state.storeKey)||'{}'); }catch{ return {}; } }
  function saveEvents(map){ localStorage.setItem(state.storeKey, JSON.stringify(map)); }

  // NLP ligera
  const dowMap={domingo:0,lunes:1,martes:2,miércoles:3,miercoles:3,jueves:4,viernes:5,sábado:6,sabado:6};
  function nextDow(from, dow){ const d=new Date(from); const diff=((dow - d.getDay()) + 7) % 7 || 7; d.setDate(d.getDate()+diff); return stripTime(d); }
  function parseSmart(text, selectedDate, currentHHMM, currentOffsetMin){
    let t=text.toLowerCase(); let title=text; let date=selectedDate; let hhmm=currentHHMM; let offsetMin=currentOffsetMin; let direct=false;
    let m=t.match(/(\d+)\s*(?:min|mins|minuto|minutos)\s*antes\b/);
    if (m){ offsetMin=parseInt(m[1],10); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    m=t.match(/\ben\s+(\d+)\s*(h|hr|hrs|hora|horas|min|mins|minuto|minutos)\b/);
    if (m){ const n=parseInt(m[1],10); const unit=m[2]; let ms=/h|hr|hrs|hora/.test(unit)?n*3600000:n*60000; const when=new Date(Date.now()+ms); date=stripTime(when); hhmm=when.toTimeString().slice(0,5); offsetMin=0; direct=true; t=t.replace(m[0],''); title=title.replace(m[0],''); }
    if (!direct){
      if (/\bpasado\s+mañana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+2); date=stripTime(d); t=t.replace(/pasado\s+mañana/,''); title=title.replace(/pasado\s+mañana/i,''); }
      else if (/\bmañana\b/.test(t)){ const d=new Date(); d.setDate(d.getDate()+1); date=stripTime(d); t=t.replace(/mañana/,''); title=title.replace(/mañana/i,''); }
      else if (/\bhoy\b/.test(t)){ date=stripTime(new Date()); t=t.replace(/hoy/,''); title=title.replace(/hoy/i,''); }
      let w=t.match(/pr[óo]xim[oa]?\s+(domingo|lunes|martes|mi[eé]rcoles|miercoles|jueves|viernes|s[áa]bado|sabado)/);
      if (w){ const dname=w[1].normalize("NFD").replace(/[\u0300-\u036f]/g,''); date=nextDow(new Date(), dowMap[dname]); t=t.replace(w[0],''); title=title.replace(new RegExp(w[0],'i'),''); }
    }
    m=t.match(/\b(?:a\s+las\s+)?(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\b/);
    if (m){ let H=parseInt(m[1],10), M=m[2]?parseInt(m[2],10):0, ap=m[3]; if (ap){ if (ap==='pm' && H<12) H+=12; if (ap==='am' && H===12) H=0; } H=Math.max(0,Math.min(23,H)); M=Math.max(0,Math.min(59,M)); hhmm=String(H).padStart(2,'0')+':'+String(M).padStart(2,'0'); t=t.replace(m[0],''); title=title.replace(m[0],''); }
    title=title.replace(/\s{2,}/g,' ').trim(); return { title: title||text, date, hhmm, offsetMin };
  }

  function computeStreak(map){
    let streak=0; const today=stripTime(new Date()); let d=new Date(today);
    while(true){ const key=ymd(d), list=(map[key]||[]), hasPending=list.some(e=>!e.done && e.remindAt>0);
      if (list.length && !hasPending){ streak++; d.setDate(d.getDate()-1); continue; } break; }
    return streak;
  }

  function renderWeekdays(){
    const daysMon=['L','M','X','J','V','S','D'], daysSun=['D','L','M','X','J','V','S'];
    const list=(WEEK_START==='monday')?daysMon:daysSun;
    const html=list.map((d,i)=>`<div${(i>=5)?' style="color:#9fbaff"':''}>${d}</div>`).join('');
    els.weekdays.innerHTML=html;
  }

  function render(){
    els.monthLabel.textContent=formatMonthYear(state.view);
    const map=loadEvents();
    els.streakLabel.textContent='🔥 '+computeStreak(map);
    renderGrid(map);

    // saludo y poses
    const pose = todayPose(map);
    if (!greeted && window.__pet){
      const key = ymd(stripTime(new Date()));
      const list = map[key] || [];
      const pending = list.filter(e=>!e.done && e.remindAt>0).length;
      window.__pet.greet({ todayTotal:list.length, todayPending:pending });
      greeted=true;
    }
    if (window.__pet && pose!==lastPose){
      window.__pet.setPose(pose);
      if (pose==='alert'){ window.__pet.say('⏰ Tienes recordatorios urgentes'); }
      if (pose==='happy'){ window.__pet.say('¡Todo listo por hoy! ✨'); window.__pet.confetti(); }
      lastPose=pose;
    }
  }
  function todayPose(map){
    const key=ymd(stripTime(new Date())), list=(map[key]||[]);
    const pending=list.filter(e=>!e.done && e.remindAt>0);
    if (pending.length===0) return list.length? 'happy':'idle';
    const urg = pending.map(e=>urgencyFor(e.remindAt,false));
    if (urg.includes('high')) return 'alert';
    if (urg.includes('med'))  return 'focus';
    return 'idle';
  }

  function renderGrid(data){
    els.grid.innerHTML='';
    const first=firstOfMonth(state.view), Y=first.getFullYear(), M=first.getMonth(), pad=weekdayIndex(first), total=42;
    for(let i=0;i<total;i++){
      const dayNum=i - pad + 1, thisDate=new Date(Y, M, dayNum), inMonth=thisDate.getMonth()===M;
      const cell=document.createElement('button');
      cell.className='day' + (inMonth?'':' out') + (([0,6].includes(thisDate.getDay()))?' weekend':'');
      cell.dataset.date=ymd(thisDate);
      cell.setAttribute('aria-label', new Intl.DateTimeFormat(locale,{dateStyle:'full'}).format(thisDate));
      cell.textContent=thisDate.getDate();

      if (sameDay(thisDate,new Date())){ const ring=document.createElement('div'); ring.className='ring-today'; cell.appendChild(ring); }
      if (sameDay(thisDate,state.selected)) cell.classList.add('selected');

      const dots=document.createElement('div'); dots.className='badges';
      const list=data[ ymd(thisDate) ] || [];
      if (list.length){
        const urgSet=new Set(); let max='low';
        list.forEach(it=>{
          const u=urgencyFor(it.remindAt, it.done);
          if (!it.done) urgSet.add(u);
          if (u==='high') max='high'; else if (u==='med' && max!=='high') max='med'; else if (u==='past' && max!=='high' && max!=='med') max='past';
        });
        if (urgSet.size) cell.dataset.maxurg=max;
        ['high','med','low','past'].filter(u=>urgSet.has(u)).slice(0,3).forEach(u=>{
          const dot=document.createElement('span'); dot.className='dot '+u; dots.appendChild(dot);
        });
      }
      cell.appendChild(dots);
      cell.addEventListener('click', ()=>{ state.selected=stripTime(thisDate); openSheet(); renderGrid(loadEvents()); });
      els.grid.appendChild(cell);
    }
  }

  function openSheet(){ els.sheet.classList.add('open'); els.sheetDate.textContent=formatLong(state.selected); paintDayEvents(); buildQuickChips(); updatePreview(); setTimeout(()=>{ if(!els.evTitle.value) els.evTitle.focus(); }, 120); }
  function closeSheetFn(){ els.sheet.classList.remove('open'); }
  els.closeSheet.addEventListener('click', closeSheetFn);

  function buildQuickChips(){
    const now=new Date();
    const chips=[
      {label:'+30m', act:()=> setFromRelative(30)},
      {label:'+1h', act:()=> setFromRelative(60)},
      {label:'Hoy 18:00', act:()=> setDateTime(stripTime(new Date()), '18:00')},
      {label:'Mañana 9:00', act:()=> {const d=new Date(); d.setDate(d.getDate()+1); setDateTime(stripTime(d),'09:00');}},
      {label:'Próx. Lunes 9:00', act:()=> setDateTime(nextDow(new Date(),1),'09:00')},
    ];
    const box=document.getElementById('quickChips');
    box.innerHTML='';
    chips.forEach(c=>{ const b=document.createElement('button'); b.className='chip-btn'; b.textContent=c.label; b.addEventListener('click', ()=>{ c.act(); updatePreview(); }); box.appendChild(b); });
    function setFromRelative(min){ const when=new Date(now.getTime()+min*60000); setDateTime(stripTime(when), when.toTimeString().slice(0,5)); els.evOffset.value='0'; }
    function setDateTime(d, hhmm){ state.selected=d; els.sheetDate.textContent=formatLong(d); els.evTime.value=hhmm; }
  }

  function paintDayEvents(){
    if (!els.sheet.classList.contains('open')) return;
    const data=loadEvents(), key=ymd(state.selected), items=data[key]||[];
    els.evList.innerHTML = items.length ? '' : `<div class="subtitle" style="margin-top:6px">Sin recordatorios todavía.</div>`;
    items.map((it,idx)=>({it,idx,u:urgencyFor(it.remindAt,it.done)}))
      .sort((a,b)=>({high:0,med:1,low:2,past:3}[a.u]-({high:0,med:1,low:2,past:3}[b.u])))
      .forEach(({it,idx,u})=>{
        const row=document.createElement('div'); row.className='ev'; if (it.done) row.classList.add('done'); row.dataset.urg=u;
        const when=new Date(it.remindAt), diff=when.getTime()-Date.now(), rel=relTime(diff);
        const off=it.offsetMin ? ` · ${it.offsetMin} min antes` : '';
        row.innerHTML=`
          <div class="time">${it.time||'--:--'}</div>
          <div class="title">${escapeHtml(it.title||'Sin título')}</div>
          <div class="meta">${rel}${off}</div>
          <div style="margin-left:10px; display:flex; gap:6px">
            <button class="mini good" data-done="${idx}" title="Marcar hecho">✔</button>
            <button class="mini" data-snooze="${idx}" title="Posponer 10 min">⏰+10m</button>
            <button class="mini tg" data-tg="${idx}" title="Compartir por Telegram">📤 TG</button>
            <button class="mini danger" data-del="${idx}" title="Eliminar">🗑</button>
          </div>`;
        row.querySelector('[data-del]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-del')); const map=loadEvents(); map[key].splice(i,1); saveEvents(map); paintDayEvents(); render();
        });
        row.querySelector('[data-done]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-done')); const map=loadEvents(); map[key][i].done=!map[key][i].done; saveEvents(map); paintDayEvents(); render();
          if (window.__pet){ window.__pet.say('¡Bien hecho! ✔'); window.__pet.confetti(); }
        });
        row.querySelector('[data-snooze]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-snooze')); const map=loadEvents(); const now=Date.now();
          map[key][i].remindAt = now + 10*60000;
          const d=new Date(map[key][i].remindAt); map[key][i].date=ymd(d); map[key][i].time=d.toTimeString().slice(0,5);
          saveEvents(map);
          if (map[key][i].date!==key){ const moved=map[key].splice(i,1)[0]; map[moved.date]=map[moved.date]||[]; map[moved.date].push(moved); saveEvents(map); }
          paintDayEvents(); render();
          if (window.__pet){ window.__pet.say('Lo pospuse 10 min ⏰'); }
        });
        // NUEVO: compartir por Telegram
        row.querySelector('[data-tg]').addEventListener('click', e=>{
          const i=Number(e.currentTarget.getAttribute('data-tg'));
          const ev=items[i];
          const link=tgShareLinkFromEvent(ev.title, ev.eventAt, ev.offsetMin);
          window.open(link, '_blank', 'noopener,noreferrer');
        });
        els.evList.appendChild(row);
      });
  }

  // Vista previa en vivo
  function updatePreview(){
    const parsed = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    const eventAt = toDateTime(parsed.date, parsed.hhmm);
    const whenTxt = new Intl.DateTimeFormat('es-MX',{weekday:'short', day:'numeric', month:'short'}).format(parsed.date);
    const offsetTxt = parsed.offsetMin ? ` · 🔔 ${parsed.offsetMin}m antes` : '';
    els.previewText.textContent = `📌 ${parsed.title || '—'}  ·  ⏱️ ${whenTxt} ${parsed.hhmm}${offsetTxt}`;
  }
  ['keyup','change','input'].forEach(ev=>{
    document.getElementById('evTitle').addEventListener(ev, updatePreview);
    document.getElementById('evTime').addEventListener(ev, updatePreview);
    document.getElementById('evOffset').addEventListener(ev, updatePreview);
  });

  // Guardar genérico (reutilizado por guardar y guardar+TG)
  function persistParsed(parsed){
    state.selected = parsed.date;
    const eventAt = toDateTime(parsed.date, parsed.hhmm);
    const remindAt = new Date(eventAt.getTime() - parsed.offsetMin*60000);
    const map=loadEvents(); const key=ymd(parsed.date);
    map[key]=map[key]||[];
    const obj={ title: parsed.title, date:key, time:parsed.hhmm, offsetMin:parsed.offsetMin, eventAt:eventAt.getTime(), remindAt:remindAt.getTime(), createdAt:Date.now(), done:false };
    map[key].push(obj);
    saveEvents(map);
    els.evTitle.value=''; els.evTime.value=parsed.hhmm; els.evOffset.value=String(parsed.offsetMin);
    els.sheetDate.textContent=formatLong(parsed.date); updatePreview(); paintDayEvents(); render();
    return {eventAt, remindAt, obj};
  }

  // Guardar
  els.saveBtn.addEventListener('click', ()=>{
    const parsed = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    if (!parsed.title){ els.evTitle.focus(); return; }
    const {remindAt} = persistParsed(parsed);
    toast('✅ Recordatorio guardado');
    if (window.__pet){ const diff=remindAt.getTime()-Date.now(); window.__pet.say('¡Anotado! Te aviso ' + relTime(diff)); window.__pet.confetti(); }
  });

  // NUEVO: Guardar + abrir Telegram
  els.saveTgBtn.addEventListener('click', ()=>{
    const parsed = parseSmart(els.evTitle.value.trim(), state.selected, (els.evTime.value||'09:00'), parseInt(els.evOffset.value||'0',10));
    if (!parsed.title){ els.evTitle.focus(); return; }
    const {eventAt, remindAt, obj} = persistParsed(parsed);
    toast('✅ Guardado · Abriendo Telegram…');
    const link = tgShareLinkFromEvent(obj.title, eventAt.getTime(), obj.offsetMin);
    window.open(link, '_blank', 'noopener,noreferrer');
    if (window.__pet){ const diff=remindAt.getTime()-Date.now(); window.__pet.say('¡Enviado a Telegram! ✈️ ' + relTime(diff)); window.__pet.confetti(); }
  });

  // FAB & navegación
  els.fab.addEventListener('click', ()=>{ if (!els.sheet.classList.contains('open')) openSheet(); els.evTitle.focus(); });
  els.prevBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()-1, 1); render(); });
  els.nextBtn.addEventListener('click', ()=>{ state.view=new Date(state.view.getFullYear(), state.view.getMonth()+1, 1); render(); });
  els.todayBtn.addEventListener('click', ()=>{ const t=stripTime(new Date()); state.view=new Date(t.getFullYear(), t.getMonth(), 1); state.selected=t; render(); openSheet(); });

  // Gestos
  els.grid.addEventListener('touchstart', e=>{ state.touch={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()}; }, {passive:true});
  els.grid.addEventListener('touchend', e=>{
    if (!state.touch) return; const dx=e.changedTouches[0].clientX-state.touch.x, dy=e.changedTouches[0].clientY-state.touch.y, dt=Date.now()-state.touch.t;
    if (Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy) && dt<450){ (dx<0)?els.nextBtn.click():els.prevBtn.click(); }
    state.touch=null;
  });

  // Drag para sheet
  let dragStartY=null;
  document.getElementById('dragbar').addEventListener('touchstart', e=>{ dragStartY=e.touches[0].clientY; }, {passive:true});
  document.getElementById('dragbar').addEventListener('touchend', e=>{ if(dragStartY==null) return; const dy=e.changedTouches[0].clientY-dragStartY; if (dy>40) els.closeSheet.click(); dragStartY=null; });

  // init
  (function start(){ renderWeekdays(); render(); if (els.sheet.classList.contains('open')) updatePreview(); setInterval(()=>{ render(); if (els.sheet.classList.contains('open')) { paintDayEvents(); updatePreview(); } }, 60*1000); })();
}
</script>
</body>
</html>
